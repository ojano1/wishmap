/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
If you want to view the source, see the repository of this plugin.
*/
"use strict";var Rt=Object.defineProperty;var Ln=Object.getOwnPropertyDescriptor;var Dn=Object.getOwnPropertyNames;var Nn=Object.prototype.hasOwnProperty;var On=(t,e)=>{for(var n in e)Rt(t,n,{get:e[n],enumerable:!0})},Rn=(t,e,n,a)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of Dn(e))!Nn.call(t,r)&&r!==n&&Rt(t,r,{get:()=>e[r],enumerable:!(a=Ln(e,r))||a.enumerable});return t};var Yn=t=>Rn(Rt({},"__esModule",{value:!0}),t);var Wr={};On(Wr,{default:()=>Ot});module.exports=Yn(Wr);var v=require("obsidian");var Wt=require("obsidian");var ot=require("obsidian");async function me(t,e,n,a){let r=await t.vault.read(e),o=new RegExp(String.raw`^#{1,6}.*?\b${n.replace(/\s+/g,"\\s+")}\b.*$`,"im").exec(r);if(!o)return;let l=o.index+o[0].length,c=r.slice(l).split(/\r?\n/),d=h=>/^#{1,6}\s/.test(h);for(let h=0;h<c.length;h++){let p=c[h];if(d(p)){c.splice(h,0,a);let f=r.slice(0,l)+c.join(`
`);f!==r&&await t.vault.modify(e,f);return}if(p.trim()!==""){if(p!==a){c[h]=a;let f=r.slice(0,l)+c.join(`
`);f!==r&&await t.vault.modify(e,f)}return}}if(c.length===0){let h=r.slice(0,l)+a;h!==r&&await t.vault.modify(e,h);return}c[0]=a;let u=r.slice(0,l)+c.join(`
`);u!==r&&await t.vault.modify(e,u)}function Hn(t,e,n){let a=t.metadataCache.getFileCache(e);if(!a?.headings)return null;let r=d=>d.trim().toLowerCase(),s=r(n),o=a.headings.sort((d,u)=>d.position.start.line-u.position.start.line),l=o.findIndex(d=>r(d.heading)===s);if(l===-1)return null;let i=o[l].position.end.line+1,c=l<o.length-1?o[l+1].position.start.line-1:Number.MAX_SAFE_INTEGER;return{startLine:i,endLine:c}}async function ge(t,e,n,a){let r=Hn(t,e,n);if(!r)return!1;let o=(await t.vault.read(e)).split(`
`),l=Math.min(r.startLine,o.length-1),i=Math.min(r.endLine,o.length-1),c=/^\s*-\s*\[([ xX])\]\s*(.*)$/;for(let d=l;d<=i;d++){let u=o[d].match(c);if(!u)continue;let p=`- [${u[1]==="x"||u[1]==="X"?"x":" "}] ${a}`;return o[d]!==p&&(o[d]=p,await t.vault.modify(e,o.join(`
`))),!0}return!1}function O(t=new Date){let e=t.getTimezoneOffset();return new Date(t.getTime()-e*6e4).toISOString().slice(0,10)}function jn(t=new Date){return t.toLocaleDateString(void 0,{weekday:"long"})}function Wn(t=new Date){return t.toLocaleDateString(void 0,{month:"short"})}function _n(t=new Date){return t.getFullYear()}function Bn(t=new Date){return Math.floor(t.getMonth()/3)+1}function In(t=new Date){let e=new Date(Date.UTC(t.getFullYear(),t.getMonth(),t.getDate()));e.setUTCDate(e.getUTCDate()+4-(e.getUTCDay()||7));let n=new Date(Date.UTC(e.getUTCFullYear(),0,1));return Math.ceil(((+e-+n)/864e5+1)/7)}function Yt(t,e,n=new Date){let a=O(n),r=t;return r=r.replace(/{{\s*title\s*}}/gi,e),r=r.replace(/{{\s*date(?:\s*:\s*([^}]+))?\s*}}/gi,s=>a),r=r.replace(/{{\s*dateLong\s*}}/gi,n.toLocaleDateString(void 0,{year:"numeric",month:"long",day:"numeric"})),r=r.replace(/{{\s*weekday\s*}}/gi,jn(n)),r=r.replace(/{{\s*monthShort\s*}}/gi,Wn(n)),r=r.replace(/{{\s*year\s*}}/gi,String(_n(n))),r=r.replace(/{{\s*isoWeek\s*}}/gi,String(In(n))),r=r.replace(/{{\s*quarter\s*}}/gi,String(Bn(n))),r}function qn(t,e){let n=(0,ot.normalizePath)(e);return t.vault.getAbstractFileByPath(n)??null}async function wt(t,e){let n=(0,ot.normalizePath)(e).split("/"),a="";for(let r of n)a=a?`${a}/${r}`:r,t.vault.getAbstractFileByPath(a)||await t.vault.createFolder(a)}async function D(t,e,n){let a=(0,ot.normalizePath)(e);if(!qn(t,a)){let s=a.split("/").slice(0,-1).join("/");s&&await wt(t,s),await t.vault.create(a,n)}}var bt=require("obsidian");var N="03 SaveBox/Templates",Ht={area:`${N}/Area Template.md`,wish:`${N}/Wish Template.md`,goal:`${N}/Goal Template.md`,project:`${N}/Project Template.md`,task:`${N}/Task Template.md`,habit:`${N}/Habit Template.md`,note:`${N}/Note Template.md`,daily:`${N}/Daily Template.md`,weekly:`${N}/Weekly Template.md`,monthly:`${N}/Monthly Template.md`,quarterly:`${N}/Quarterly Template.md`,yearly:`${N}/Yearly Template.md`},jt={area:`---
created: {{date}}
status: Active
priority: Medium
tags: []
---
# {{title}}

This page defines one part of your life that matters.
Break it into **Wishes** you\u2019d love to reach.

## Step 1 \u2013 List Your Wishes
*Use links (prefix: \`wish \`).*
- [[wish \u2013 ]]
- 
`,wish:`---
created: {{date}}
status: Active
priority: Medium
tags: []
---
# {{title}}

Break this Wish into **Goals** you control.

## Step 1 \u2013 List Your Goals
**Action + measurable outcome + timeframe**

**Examples:**
- Launch 10 products in 4 months
- Build 1,000-subscriber email list in 3 months

### \u270D\uFE0F My Goals
- [[goal \u2013 ]]
- 
`,goal:`---
created: {{date}}
status: Active
done: false
priority: Medium
tags: []
---
### My Goal
- [ ] {{title}}

Break this Goal into **Projects** (milestones).

## Step 1 \u2013 List Your Projects
**Deliverable + scope + time frame**

**Examples:**
- Build Product MVP in 4 weeks
- Create Email Launch Sequence in 6 weeks

### \u270D\uFE0F My Projects
- [[project \u2013 ]]
- 
`,project:`---
created: {{date}}
status: Active
done: false
priority: Medium
tags: []
---
### My Project
- [ ] {{title}}

Break it into **Tasks** and **Habits**.

## Tasks (\u22641h)
- [[task \u2013 ]]
- 

## Habits (repeatable)
- [[habit \u2013 ]]
- 
`,task:`---
created: 2025-10-16
_task_sync_state: false
done: false
status: Active
impact: Medium
slot: Morning
duration_hours:
tags: []
due:
---

### My Task
- [ ] {{title}}
A one-time action you can finish in about an hour.
---
### Properties to fill
- **Impact**: Select one in Properties. Options: Hi, Med, Lo.
- **duration_hours**: Set a number. Example: 0.5 or 1.
---
### Keep in mind
- Split big tasks to keep them small enough for one sitting (target 1hr max).
This way it would more friendly to your daily time budget.
---
[[Link to the daily page]]
---
<p align="center">MindMap OS \xA9 All rights reserved</p>
`,habit:`---
created: {{date}}
status: Active
done: false
priority: Medium
tags: []
---
# {{title}}

Describe the habit and frequency (e.g., daily, Mon Thu, monthly on the 1st).
`,note:`---
created: {{date}}
status: Active
tags: []
---
# {{title}}
Write freely. Link with [[...]].
`,daily:`# {{dateLong}}

## \u270D\uFE0F Inbox
- 

## Highlights
- 

## Next actions
- 
`,weekly:`# \u{1F4C5} Week {{isoWeek}} {{year}}
> Review goals and plan the week.
`,monthly:`# \u{1F4C5} {{monthShort}} {{year}}
> Review progress. Pick key projects and habits.
`,quarterly:`# \u{1F4C5} Q{{quarter}} {{year}}
> Choose focus goals. Align projects.
`,yearly:`# \u{1F4C5} Year {{year}}
> Define areas and high-level goals.
`};async function it(t,e,n,a=new Date){let r=(0,bt.normalizePath)(Ht[e]),s=t.vault.getAbstractFileByPath(r);if(s instanceof bt.TFile){console.log(`[MMOS] Using VAULT template for ${e}: ${r}`);let o=await t.vault.read(s);return Yt(o,n,a)}return console.log(`[MMOS] Using FALLBACK template for ${e}`),Yt(jt[e],n,a)}var Gn="03 SaveBox/Templates";async function Un(t,e){let n=t.vault.getMarkdownFiles().filter(s=>s.path.startsWith(Gn+"/")),a=s=>s.toLowerCase().trim().replace(/^[^a-z0-9]+/,""),r=n.find(s=>new RegExp(`^${e}(\\s|:|-|_)`,"i").test(a(s.basename)));return r?t.vault.read(r):""}async function we(t,e){let{kind:n,title:a}=e,r=e.path??Kn(n,a),s=r.substring(0,r.lastIndexOf("/"));s&&await wt(t,s);let o;if(n==="note"){if(o=await Un(t,"note"),!o){let i=r.split("/").pop().replace(/\.md$/i,"");o=`---
created: ${O(new Date)}
status: Active
---
# ${i}
`}}else o=await it(t,n,a,new Date);let l=await t.vault.create(r,o);return await t.fileManager.processFrontMatter(l,i=>{i.created??(i.created=O(new Date)),n==="task"?(i.status??(i.status="Active"),i.impact??(i.impact="Med"),i.slot??(i.slot="Morning"),i.done??(i.done=!1),i.priority??(i.priority="Medium")):n==="goal"||n==="project"||n==="habit"?(i.status??(i.status="Active"),i.done??(i.done=!1),i.priority??(i.priority="Medium")):n==="area"&&(i.status??(i.status="Active"))}),l}async function be(t){let e=["01 Definition","02 Execution/1 Daily","02 Execution/2 Weekly","02 Execution/3 Monthly","02 Execution/4 Quarterly","02 Execution/5 Yearly","03 SaveBox/Active","03 SaveBox/Archive","03 SaveBox/Attachment","03 SaveBox/Scripts","03 SaveBox/Templates","04 Output","99 System"];for(let n of e)await wt(t,n);await D(t,"Welcome.md",`# \u{1F44B} Welcome to MindMap OS

Use **MindMap OS \u2192 Create Starter Structure** any time.
`),await D(t,"01 Definition/\u{1F3C1} Start Here.md",`# \u{1F3C1} MindMap OS \u2013 Start Here

### Top-Down
Areas \u2192 Goals \u2192 Projects \u2192 Tasks. Best way to start.

### Bottom-Up
Capture anything anywhere. It lands in your **Daily inbox** for linking later.

### First step
Example: [[area Health]]
- 
- 
`),await D(t,"01 Definition/\u{1F9E0} Mind Map.md",`# \u{1F9E0} Mind Map
Link Areas, Goals, Projects here.
`),await D(t,"02 Execution/\u{1F50D} Read Me First.md",`# Execution Flow
Year \u2192 Quarter \u2192 Month \u2192 Week \u2192 Day.
`),await D(t,"04 Output/Untitled.md",`# Output
Export or publish here.
`);for(let[n,a]of Object.entries(Ht))await D(t,a,jt[n]);await D(t,"03 SaveBox/Active/\u{1F331}Area - Life.md",`---
created: ${O(new Date)}
status: Active
---
# \u{1F331}Area - Life
`),await D(t,"03 SaveBox/Active/\u{1F3AF}Goal - Launch v1.md",`---
created: ${O(new Date)}
status: Active
done: false
---
### My Goal
- [ ] \u{1F3AF}Goal - Launch v1
`),await D(t,"03 SaveBox/Active/\u{1F680}Project - Landing Page.md",`---
created: ${O(new Date)}
status: Active
done: false
---
### My Project
- [ ] \u{1F680}Project - Landing Page
`),await D(t,"03 SaveBox/Active/\u{1F4CC}Task - Draft copy.md",`---
created: ${O(new Date)}
status: Active
impact: Med
slot: Morning
done: false
priority: Medium
duration_hours:
tags: []
---
### My Task
- [ ] \u{1F4CC}Task - Draft copy
`),await D(t,"99 System/Home.md",["# Welcome to MindMap OS","","- **MindMap OS \u2192 Create Starter Structure**","- **MindMap OS \u2192 New Goal / Project / Task**","- **MindMap OS \u2192 Open Today**",""].join(`
`)),new Wt.Notice("\u2705 MindMap OS: starter structure updated.")}function Kn(t,e){let n=zn(e);switch(t){case"daily":return`02 Execution/1 Daily/${n}.md`;case"weekly":return`02 Execution/2 Weekly/${n}.md`;case"monthly":return`02 Execution/3 Monthly/${n}.md`;case"quarterly":return`02 Execution/4 Quarterly/${n}.md`;case"yearly":return`02 Execution/5 Yearly/${n}.md`;case"note":return`03 SaveBox/Active/${ye("note")}${n}.md`;default:return`03 SaveBox/Active/${ye(t)}${n}.md`}}function ye(t){switch(t){case"area":return"\u{1F331}Area - ";case"wish":return"\u2728Wish - ";case"goal":return"\u{1F3AF}Goal - ";case"project":return"\u{1F680}Project - ";case"task":return"\u{1F4CC}Task - ";case"habit":return"\u{1F501}Habit - ";case"note":return"\u270F\uFE0FNote - ";default:return""}}function zn(t){return t.replace(/[\\/:*?"<>|]/g,"").trim()}var V=require("obsidian");var Qn=["task","project","goal","area","habit","note","daily","weekly","monthly","quarterly","yearly","wish"],_t={area:"\u{1F331}Area - ",wish:"\u2728Wish - ",goal:"\u{1F3AF}Goal - ",project:"\u{1F680}Project - ",task:"\u{1F4CC}Task - ",habit:"\u{1F504}Habit - ",note:"\u270F\uFE0FNote - ",daily:"",weekly:"",monthly:"",quarterly:"",yearly:""};function Xn(t){return String(t).replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function Vn(t,e){let a=new RegExp(`^#{1,6}\\s+${Xn(e)}\\s*$`,"gim").exec(t);if(!a)return null;let r=a.index+a[0].length,s=(a[0].match(/^#+/)||["#"])[0].length,o=new RegExp(`^#{1,${s}}\\s+`,"gim");o.lastIndex=r;let l=o.exec(t);return{start:r,end:l?l.index:t.length}}function Jn(t,e){let n=/^[ \t>]*[-*]\s+\[( |x|X)\]\s.*$/gim,a=t.slice(e.start,e.end);n.lastIndex=0;let r=n.exec(a);if(!r)return null;let s=e.start+r.index,o=s+r[0].length,l=/\[(x|X)\]/.test(r[0]);return{absStart:s,absEnd:o,line:r[0],checked:l}}async function Zn(t,e){for(let n=0;n<25;n++){if(t.metadataCache.getFileCache(e)?.headings?.length)return;await new Promise(r=>setTimeout(r,40))}}async function ta(t,e,n,a){await Zn(t,e);let r=await t.vault.read(e),s=Vn(r,n);if(!s)return!1;let o=Jn(r,s);if(!o)return!1;let i=`- [${/\[(x|X)\]/.test(o.line)?"x":" "}] ${a}`;if(o.line.trimEnd()===i)return!0;let c=r.slice(0,o.absStart)+i+r.slice(o.absEnd);return c!==r&&await t.vault.modify(e,c),!0}function ea(t){return t==="task"?"My Task":t==="project"?"My Project":"My Goal"}function na(t){return t instanceof V.TFile&&t.extension.toLowerCase()==="md"}function aa(t){let e=t.match(/^(\w+)\s*(?:[-–]\s*|\s+)(.+)$/i);if(!e)return null;let n=e[1].toLowerCase();if(!Qn.includes(n))return null;let a=e[2].trim();return{kind:n,title:a}}function ra(t,e){let n=sa(e);switch(t){case"daily":return`02 Execution/1 Daily/${n}.md`;case"weekly":return`02 Execution/2 Weekly/${n}.md`;case"monthly":return`02 Execution/3 Monthly/${n}.md`;case"quarterly":return`02 Execution/4 Quarterly/${n}.md`;case"yearly":return`02 Execution/5 Yearly/${n}.md`;case"note":return`03 SaveBox/Active/${_t.note}${n}.md`;default:return`03 SaveBox/Active/${_t[t]}${n}.md`}}function sa(t){return t.replace(/[\\/:*?"<>|]/g,"").trim()}async function oa(t,e,n){await t.fileManager.processFrontMatter(e,a=>{a.created??(a.created=O(new Date)),n==="task"?(a.status??(a.status="Active"),a.impact??(a.impact="Medium"),a.slot??(a.slot="Morning"),a.done??(a.done=!1),a.duration_hours??(a.duration_hours=void 0),a.tags??(a.tags=[])):n==="goal"||n==="project"||n==="habit"?(a.status??(a.status="Active"),a.done??(a.done=!1)):n==="area"&&(a.status??(a.status="Active"))})}function Te(t){t.vault.on("create",async e=>{try{if(!na(e)||(await t.vault.read(e)).trim().length>0)return;let a=e.basename,r=aa(a);if(!r)return;let{kind:s,title:o}=r,l;s==="note"?(l=await it(t,"note",o,new Date),l||(l=`---
created: ${O(new Date)}
status: Active
---
# \u270F\uFE0FNote - ${o}
`)):l=await it(t,s,o,new Date),await t.vault.modify(e,l),await oa(t,e,s);let i=(0,V.normalizePath)(ra(s,o));if(i!==e.path&&await t.fileManager.renameFile(e,i),s==="area"||s==="wish"){let c=t.vault.getAbstractFileByPath(i),d=c instanceof V.TFile?c:e,u=d.basename.replace(/^\p{Extended_Pictographic}?\s*[A-Za-z]+\s*-\s*/u,"").trim(),h=`${_t[s]}${u}`,p=s==="area"?"My Area":"My Wish";console.log("[MMOS][wikilinks] finalize",{kind:s,formatted:h,path:d.path}),await me(t,d,p,h)}if(s==="task"||s==="project"||s==="goal"){let c=t.vault.getAbstractFileByPath(i),d=c instanceof V.TFile?c:e,u=ea(s),h=d.basename;await ta(t,d,u,h)}console.log(`[MMOS] wikilink routed \u2192 ${s} | ${o}`)}catch(n){console.error("[MMOS] wikilink routing error",n)}}),console.log("MMOS wikilink watcher: ON")}var ve=require("obsidian");function ia(t){return String(t).replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function ca(t,e){let n=null;return(...a)=>{n&&window.clearTimeout(n),n=window.setTimeout(()=>{n=null,t(...a)},e)}}function ke(t,e){let a=new RegExp(`^#{1,6}\\s+${ia(e)}\\s*$`,"gim").exec(t);if(!a)return null;let r=a.index+a[0].length,s=(a[0].match(/^#+/)||["#"])[0].length,o=new RegExp(`^#{1,${s}}\\s+`,"gim");o.lastIndex=r;let l=o.exec(t);return{start:r,end:l?l.index:t.length}}var xe=/^[ \t>]*[-*]\s+\[( |x|X)\]\s.*$/gim;function Ae(t,e){let n=t.slice(e.start,e.end);xe.lastIndex=0;let a=xe.exec(n);if(!a)return null;let r=e.start+a.index,s=r+a[0].length,o=/\[(x|X)\]/.test(a[0]);return{absStart:r,absEnd:s,line:a[0],checked:o}}function $e(t,e){return t.replace(/\[(?: |x|X)\]/,e?"[x]":"[ ]")}var la=2e3;function da(t){return/(^|\/)(templates?|Templates?)(\/|$)/.test(t)}function ua(t){return t?.template===!0||t?.is_template===!0||t?.type==="template"}function ha(t){return/<%[\s\S]*?%>/.test(t)}function fa(t){let e=t?.stat?.ctime??0;return Date.now()-e<la}function Fe(t,e){let n=new Set,a=t.vault.on("modify",c=>{n.has(c.path)&&t?.notifier?.hideAll&&t.notifier.hideAll()}),r=c=>{let d=t.workspace.getActiveViewOfType(ve.MarkdownView),h=!!d&&d.file?.path===c.path&&d?.getMode()!=="preview";return{editor:d?.editor,inEdit:h}},s=async(c,d)=>{n.add(c.path);try{await t.fileManager.processFrontMatter(c,u=>{for(let h of Object.keys(d))u[h]=d[h]})}finally{n.delete(c.path)}},o=async(c,d,u,h,p)=>{let{editor:f,inEdit:T}=r(c);n.add(c.path);try{if(T&&f){let g=f.offsetToPos(u),k=f.offsetToPos(h);await new Promise(requestAnimationFrame),f.replaceRange(p,g,k)}else{let g=d.slice(0,u)+p+d.slice(h);g!==d&&await t.vault.modify(c,g)}}finally{n.delete(c.path)}},i=ca(async()=>{let c=t.workspace.getActiveFile();if(!c||e?.(c)||da(c.path))return;let u=(t.metadataCache.getFileCache(c)??{}).frontmatter??{};if(ua(u))return;let{editor:h,inEdit:p}=r(c),f=p&&h?h.getValue():await t.vault.read(c);if(!f||ha(f)||!/^#{1,6}\s+My\s+(Task|Project|Goal)\s*$/im.test(f)||fa(c)||n.has(c.path))return;let g=[{heading:"My Task",flag:"_task_sync_state"},{heading:"My Project",flag:"_project_sync_state"},{heading:"My Goal",flag:"_goal_sync_state"}];for(let k of g){let x=ke(f,k.heading);if(!x)continue;let m=Ae(f,x);if(!m)continue;let b=typeof u.done=="boolean"?u.done:null,L=typeof u[k.flag]=="boolean"?u[k.flag]:null,E=m.checked;if(L===null){await s(c,{done:!!E,[k.flag]:!!E});return}let st=b!==null&&b!==L;if(E!==L){await s(c,{done:!!E,[k.flag]:!!E});return}if(st){let Cn=$e(m.line,!!b);await o(c,f,m.absStart,m.absEnd,Cn),await s(c,{[k.flag]:!!b});return}return}},150);t.workspace.on("file-open",()=>i()),t.workspace.on("active-leaf-change",()=>i()),t.workspace.on("layout-change",()=>i()),t.workspace.on("editor-change",()=>i()),t.metadataCache.on("changed",()=>i()),t.metadataCache.on("resolved",()=>i()),t.vault.on("modify",()=>i()),t.vault.on("rename",()=>i()),t.vault.on("create",()=>i())}async function Me(t,e){let a=(t.metadataCache.getFileCache(e)??{}).frontmatter??{},r=!(typeof a.done=="boolean"&&a.done);await t.fileManager.processFrontMatter(e,l=>{l.done=r});let s=await t.vault.read(e),o=["My Task","My Project","My Goal"];for(let l of o){let i=ke(s,l);if(!i)continue;let c=Ae(s,i);if(!c)continue;let d=$e(c.line,r),u=s.slice(0,c.absStart)+d+s.slice(c.absEnd);u!==s&&await t.vault.modify(e,u);break}}var Pe=require("obsidian");function pa(t){return String(t).replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function ma(t,e){let n=null;return(...a)=>{n&&window.clearTimeout(n),n=window.setTimeout(()=>{n=null,t(...a)},e)}}function ga(t){return/(^|\/)(templates?|Templates?)(\/|$)/.test(t)}function ya(t){return/<%[\s\S]*?%>/.test(t)}function wa(t,e=1500){let n=t?.stat?.ctime??0;return Date.now()-n<e}function ba(t,e,n,a){return/(^|\/)(_?templates?|Templates)(\/|$)/.test(t)||/^habit template(\.md)?$/i.test(e)?!1:!!(/^(?:\p{Emoji_Presentation}|\p{Extended_Pictographic})?\s*Habit\s*-\s*/iu.test(e)||a&&/(^|\n)\s*type\s*:\s*habit\s*($|\n)/i.test(n))}function Ta(t,e){let n=e.map(pa).join("|"),r=new RegExp(`^#{1,6}\\s+(?:.*?\\s)?(?:${n})\\s*$`,"gim").exec(t);if(!r)return null;let s=r.index+r[0].length,o=(r[0].match(/^#+/)||["#"])[0].length,l=new RegExp(`^#{1,${o}}\\s+`,"gim");l.lastIndex=s;let i=l.exec(t);return{start:s,end:i?i.index:t.length}}var Se=/^[ \t>]*[-*]\s+\[( |x|X)\]\s.*$/gmi;function xa(t,e){let n=t.slice(e.start,e.end);Se.lastIndex=0;let a=Se.exec(n);if(!a)return null;let r=e.start+a.index,s=r+a[0].length,o=/\[(x|X)\]/.test(a[0]);return{absStart:r,absEnd:s,line:a[0],checked:o}}function va(t,e){return t.replace(/\[(?: |x|X)\]/,e?"[x]":"[ ]")}function Ee(t,e){let n=new Set,a=i=>{let c=t.workspace.getActiveViewOfType(Pe.MarkdownView),u=!!c&&c.file?.path===i.path&&c?.getMode()!=="preview";return{editor:c?.editor,inEdit:u}},r=async(i,c)=>{n.add(i.path);try{await t.fileManager.processFrontMatter(i,d=>{for(let u of Object.keys(c))d[u]=c[u]})}finally{n.delete(i.path)}},s=async(i,c,d,u,h)=>{let{editor:p,inEdit:f}=a(i);n.add(i.path);try{if(f&&p){let T=p.offsetToPos(d),g=p.offsetToPos(u);await new Promise(requestAnimationFrame),p.replaceRange(h,T,g)}else{let T=c.slice(0,d)+h+c.slice(u);T!==c&&await t.vault.modify(i,T)}}finally{n.delete(i.path)}},l=ma(async()=>{let i=t.workspace.getActiveFile();if(!i||e?.(i)||ga(i.path)||wa(i)||n.has(i.path))return;let d=(t.metadataCache.getFileCache(i)??{}).frontmatter??{},{editor:u,inEdit:h}=a(i),p=h&&u?u.getValue():await t.vault.read(i);if(!p||ya(p)||!ba(i.path,i.basename,p,d))return;let f=Ta(p,["\u270D\uFE0F Log","Log"]);if(!f)return;let T=xa(p,f),g=typeof d.done=="boolean"?d.done:null,k=typeof d._habit_sync_state=="boolean"?d._habit_sync_state:null;if(!T&&g===null)return;if(k===null){T?await r(i,{done:!!T.checked,_habit_sync_state:!!T.checked}):g!==null&&await r(i,{_habit_sync_state:!!g});return}let x=T?T.checked:null,m=g!==null&&g!==k;if(x!==null&&x!==k){await r(i,{done:!!x,_habit_sync_state:!!x});return}if(m&&T){let L=va(T.line,!!g);await s(i,p,T.absStart,T.absEnd,L),await r(i,{_habit_sync_state:!!g});return}},150);t.workspace.on("file-open",()=>l()),t.workspace.on("active-leaf-change",()=>l()),t.workspace.on("layout-change",()=>l()),t.workspace.on("editor-change",()=>l()),t.metadataCache.on("changed",()=>l()),t.metadataCache.on("resolved",()=>l()),t.vault.on("modify",()=>l()),t.vault.on("rename",()=>l()),t.vault.on("create",()=>l())}var R=require("obsidian");var xt={area:"\u{1F331}Area - ",wish:"\u2728Wish - ",goal:"\u{1F3AF}Goal - ",project:"\u{1F680}Project - ",task:"\u{1F4CC}Task - ",habit:"\u{1F504}Habit - ",note:"\u270F\uFE0FNote - "},ka="03 SaveBox/Templates";function Re(t){return t.replace(/^\p{Extended_Pictographic}?\s*[A-Za-z]+\s*-\s*/u,"").trim()}function Ce(t){return t.toLowerCase().replace(/[^a-z0-9\s]/g," ").replace(/\s+/g," ").trim()}async function Ye(t,e,n,a){let s=(await t.vault.read(e)).split(/\r?\n/),o=Ce(n),l=-1;for(let f=0;f<s.length;f++)if(/^#{1,6}\s/.test(s[f])&&Ce(s[f]).includes(o)){l=f;break}if(console.log("[MMOS][writer] target header:",n,"| found index:",l),l===-1){console.warn("[MMOS][writer] header not found in",e.path);return}let i=f=>/^\s*$/.test(f),c=f=>/^\s*(?:-{3,}|_{3,}|\*{3,})\s*$/.test(f),d=l+1;for(;d<s.length&&(i(s[d])||c(s[d]));)d++;let u=d>=s.length||/^#{1,6}\s/.test(s[d]);console.log("[MMOS][writer] insert/replace at line:",d,"| nextIsHeader:",u,"| writing:",a),u?(s.splice(d,0,a),await t.vault.modify(e,s.join(`
`))):s[d]!==a?(console.log("[MMOS][writer] replacing existing line:",JSON.stringify(s[d])),s[d]=a,await t.vault.modify(e,s.join(`
`))):console.log("[MMOS][writer] already correct, skipping write");let p=(await t.vault.read(e)).split(/\r?\n/)[d]??"";console.log("[MMOS][writer] post-write line:",JSON.stringify(p))}async function Le(t,e){for(let r=0;r<25&&!t.metadataCache.getFileCache(e)?.headings?.length;r++)await new Promise(o=>setTimeout(o,40));let n=Re(e.basename),a=`${xt.area}${n}`;console.log("[MMOS][finalizeArea]",{path:e.path,basename:e.basename,core:n,formatted:a}),await Ye(t,e,"My Area",a)}async function De(t,e){for(let r=0;r<25&&!t.metadataCache.getFileCache(e)?.headings?.length;r++)await new Promise(o=>setTimeout(o,40));let n=Re(e.basename),a=`${xt.wish}${n}`;console.log("[MMOS][finalizeWish]",{path:e.path,basename:e.basename,core:n,formatted:a}),await Ye(t,e,"My Wish",a)}function Tt(t){return t.replace(/[\\/:*?"<>|]/g,"").trim()}function He(t){return t.trim().split(/\s+/).map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ")}function Aa(t){let e=new Date(Date.UTC(t.getFullYear(),t.getMonth(),t.getDate()));e.setUTCDate(e.getUTCDate()+4-(e.getUTCDay()||7));let n=new Date(Date.UTC(e.getUTCFullYear(),0,1)),a=Math.ceil(((e.getTime()-n.getTime())/864e5+1)/7);return{isoYear:e.getUTCFullYear(),week:a}}async function je(t,e){let n=(0,R.normalizePath)(e).split("/"),a="";for(let r of n){a=a?`${a}/${r}`:r;try{await t.vault.createFolder(a)}catch{}}}function J(t,e){let n=t.vault.getAbstractFileByPath((0,R.normalizePath)(e));return n instanceof R.TFile?n:null}function $a(t,e){let n=new Date;switch(t){case"daily":return`02 Execution/1 Daily/${`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,"0")}-${String(n.getDate()).padStart(2,"0")}.md`}`;case"weekly":{let{isoYear:a,week:r}=Aa(n);return`02 Execution/2 Weekly/${`${a}-W${String(r).padStart(2,"0")}.md`}`}case"monthly":return`02 Execution/3 Monthly/${`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,"0")}.md`}`;case"quarterly":{let a=Math.floor(n.getMonth()/3)+1;return`02 Execution/4 Quarterly/${`${n.getFullYear()}-Q${a}.md`}`}case"yearly":return`02 Execution/5 Yearly/${`${n.getFullYear()}.md`}`;case"note":return`03 SaveBox/Active/\u270F\uFE0FNote - ${Tt(e)}.md`;case"area":case"wish":case"goal":case"project":case"task":case"habit":return`03 SaveBox/Active/${xt[t]}${Tt(e)}.md`}return`03 SaveBox/Active/${Tt(e)}.md`}async function Ne(t,e){let n=`${e.charAt(0).toUpperCase()}${e.slice(1)} Template.md`,a=(0,R.normalizePath)(`${ka}/${n}`),r=t.vault.getAbstractFileByPath(a);return r instanceof R.TFile?t.vault.read(r):""}async function Fa(t,e,n){let a=(0,R.normalizePath)(e),r=a.replace(/\/[^/]+$/,""),s=a.split("/").pop();await je(t,r);let o=J(t,a);if(o)return o;let l=t.vault.getFiles().find(c=>c.name===s);if(l&&l.path!==a){await t.fileManager.renameFile(l,a);let c=J(t,a);if(c){if(!(await t.vault.read(c)).trim()){let u=await Ne(t,n);u&&await t.vault.modify(c,u)}return c}}let i=await Ne(t,n);return await t.vault.create(a,i??"")}async function Oe(t,e,n){if(!["task","project","goal","area","wish","habit","note"].includes(n))return e;let a=xt[n],r=e.path.startsWith("03 SaveBox/Active/"),s=e.basename.startsWith(a);if(!r||s)return e;let o=e.basename.replace(/^\p{Extended_Pictographic}?\s*[A-Za-z]+\s*-\s*/u,"").trim(),l=He(o||"Untitled"),i=(0,R.normalizePath)(`03 SaveBox/Active/${a}${Tt(l)}.md`);if(i===e.path)return e;let c=J(t,i);return c||(await t.fileManager.renameFile(e,i),J(t,i)??e)}function Ma(t){return t==="task"?"My Task":t==="project"?"My Project":"My Goal"}async function Sa(t,e,n){for(let s=0;s<25&&!t.metadataCache.getFileCache(e)?.headings?.length;s++)await new Promise(l=>setTimeout(l,40));let a=e.basename,r=Ma(n);await ge(t,e,r,a)}async function B(t,e,n){let a=(0,R.normalizePath)($a(e,n));if(e==="daily"||e==="weekly"||e==="monthly"||e==="quarterly"||e==="yearly"){console.log("[MMOS][routeKind] periodic:",{kind:e,targetPath:a});let u=await Fa(t,a,e);return await t.workspace.getLeaf(!1).openFile(u),u}let s=["task","project","goal","area","wish","habit","note"].includes(e)?He(n):n,o=J(t,a);if(o){console.log("[MMOS][routeKind] existing at target:",{kind:e,targetPath:a});let u=await Oe(t,o,e);return e==="area"&&await Le(t,u),e==="wish"&&await De(t,u),await t.workspace.getLeaf(!1).openFile(u),u}console.log("[MMOS][routeKind] createTypedNote:",{kind:e,effectiveTitle:s,targetPath:a});let l=await we(t,{kind:e,title:s}),i=a.replace(/\/[^/]+$/,"");await je(t,i),l.path!==a&&await t.fileManager.renameFile(l,a);let c=J(t,a)??l;console.log("[MMOS][routeKind] moved/created final:",{kind:e,finalPath:c.path}),(e==="task"||e==="project"||e==="goal")&&await Sa(t,c,e),e==="area"&&await Le(t,c),e==="wish"&&await De(t,c);let d=await Oe(t,c,e);return console.log("[MMOS][routeKind] ensurePrefixedName ->",{from:c.path,to:d.path,kind:e}),await t.workspace.getLeaf(!1).openFile(d),d}var We=(t,e)=>B(t,"task",e),_e=(t,e)=>B(t,"project",e),Be=(t,e)=>B(t,"goal",e);var ct=t=>B(t,"daily",""),Bt=t=>B(t,"weekly",""),It=t=>B(t,"monthly",""),qt=t=>B(t,"quarterly",""),Gt=t=>B(t,"yearly","");var Pa=window.moment,Ut=new Set,Ea={Monday:["monday","mon","senin","sen"],Tuesday:["tuesday","tue","tues","selasa","sel"],Wednesday:["wednesday","wed","rabu","rab"],Thursday:["thursday","thu","thur","thurs","kamis","kam"],Friday:["friday","fri","jumat","jum'at","jum"],Saturday:["saturday","sat","sabtu","sab"],Sunday:["sunday","sun","minggu","ming","ahad","ahd"]},Kt={};for(let[t,e]of Object.entries(Ea))for(let n of e)Kt[n.toLowerCase()]=t;var Ca=Object.keys(Kt).sort((t,e)=>e.length-t.length).join("|"),La=new RegExp(`\\b(?:${Ca})\\b`,"gi");function Da(t){let n=/^#{1,6}\s*.*\blog\b.*$/mi.exec(t);if(!n)return null;let a=n[0],r=n.index+a.length;return t[r]==="\r"&&t[r+1]===`
`?r+2:t[r]===`
`?r+1:r}function Na(t,e){let n=Da(t);if(n===null)return t.replace(/\s*$/,"")+`

### \u270D\uFE0F Log

${e}
`;let a=t.slice(0,n),s=t.slice(n).replace(/^\r?\n{0,}/,""),o=a.endsWith(`

`)?"":a.endsWith(`
`)?`
`:`

`;return a+o+e+`
`+s}function Ie(t,e){let n=t.path;if(/(^|\/)(_?templates?|Templates)(\/|$)/.test(n)||/^habit template(\.md)?$/i.test(t.basename))return!1;if(/^(?:\p{Emoji_Presentation}|\p{Extended_Pictographic})?\s*Habit\s*-\s*/iu.test(t.basename))return!0;if(e){let a=e.match(/^---\r?\n([\s\S]*?)\r?\n---/);if(a&&/(^|\n)\s*type\s*:\s*habit\s*($|\n)/i.test(a[1]))return!0}return!1}function Oa(t){let e=t.match(La);return e?[...new Set(e.map(n=>Kt[n.toLowerCase()]).filter(Boolean))]:[]}function Ra(t){let e=Oa(t);if(e.length===0)return!0;let n=Pa().format("dddd");return e.includes(n)}function Ya(t){let e=t.match(/^[\s\S]*?\bHabit\s*-\s*(.+)$/i);return e?e[1].trim():t.trim()}async function qe(t,e,n){let a=window.moment().format("YYYY-MM-DD"),r=`^${a}`;if(n.includes(r))return!1;let o=`- [ ] \u{1F504}Habit - ${Ya(e.basename)} ${a} ${r}`,l=Na(n,o);return await t.vault.modify(e,l),!0}async function lt(t,e){let n=e.path;if(!Ut.has(n)){Ut.add(n);try{if(!Ie(e))return;if(!Ra(e.basename)){console.info("[MMOS] autolog: skip (weekly, not today)",{file:e.path});return}let a=await t.vault.read(e);if(!Ie(e,a))return;await qe(t,e,a)}finally{setTimeout(()=>Ut.delete(n),120)}}}async function Ge(t,e){let n=await t.vault.read(e);await qe(t,e,n)}var Ha=window.moment,ja="03 SaveBox/Active",Wa=/(^| )Habit -|^🔁Habit -/i,_a={Monday:["monday","mon","senin","sen"],Tuesday:["tuesday","tue","tues","selasa","sel"],Wednesday:["wednesday","wed","rabu","rab"],Thursday:["thursday","thu","thur","thurs","kamis","kam"],Friday:["friday","fri","jumat","jum'at","jum"],Saturday:["saturday","sat","sabtu","sab"],Sunday:["sunday","sun","minggu","ming","ahad","ahd"]},zt={};for(let[t,e]of Object.entries(_a))for(let n of e)zt[n.toLowerCase()]=t;var Ba=Object.keys(zt).sort((t,e)=>e.length-t.length).join("|"),Ia=new RegExp(`\\b(?:${Ba})\\b`,"gi");function qa(t){let e=t.match(Ia);return e?[...new Set(e.map(n=>zt[n.toLowerCase()]).filter(Boolean))]:[]}function Ga(t){let e=Ha().format("dddd"),n=qa(t);return{ok:n.length>0&&n.includes(e),todayName:e}}async function Ue(t,e=ja){let n=t.vault.getMarkdownFiles().filter(a=>a.path.startsWith(e+"/")).filter(a=>Wa.test(a.basename));for(let a of n){let{ok:r}=Ga(a.basename);if(r)try{await lt(t,a)}catch{}}}var vt=require("obsidian"),Y=window.moment,Ua=t=>Y(t).format("YYYY-MM-DD");function Ke(t){let e=Y(t+"-01","YYYY-MM-DD").startOf("month"),n=e.clone().endOf("month");return{start:e,end:n}}function Ka(t){return String(t).replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function za(t,e){let a=new RegExp(`^#{1,6}\\s+${Ka(e)}\\s*$`,"gim").exec(t);if(!a)return null;let r=a.index+a[0].length,s=(a[0].match(/^#+/)||["#"])[0].length,o=new RegExp(`^#{1,${s}}\\s+`,"gim");o.lastIndex=r;let l=o.exec(t);return{start:r,end:l?l.index:t.length}}function Qa(t){t=String(t).trim();let e=t.match(/(\d{4}-\d{2}-\d{2})(?:\s*\^\d{4}-\d{2}-\d{2})?\s*$/)||t.match(/due\((\d{4}-\d{2}-\d{2})\)/i)||t.match(/due::\s*(\d{4}-\d{2}-\d{2})/i)||t.match(/📅\s*(\d{4}-\d{2}-\d{2})/);return e?e[1]:null}async function Xa(t,e){let n=t.vault.getAbstractFileByPath(e.sourcePath);return n instanceof vt.TFile?t.vault.read(n):""}function Va(t){let e=za(t,"\u270D\uFE0F Log")||{start:0,end:t.length},n=t.slice(e.start,e.end),a=/^[ \t>]*[-*]\s+\[( |x|X)\]\s+(.*)$/gm,r=[],s;for(;s=a.exec(n);){let o=s[1].toLowerCase()==="x",l=s[2],i=Qa(l);i&&r.push({date:i,done:o})}return r}function Ja(t){let e=new Map;for(let n of t)e.set(n.date,e.get(n.date)||!1||n.done);return e}function Za(t){let e={};for(let[a,r]of t){let s=Y(a).format("YYYY-MM");(e[s]||(e[s]=[])).push({date:a,done:r})}return Object.keys(e).sort().slice(-3).reverse().map(a=>{let r=e[a],s=r.length?Math.round(r.filter(o=>o.done).length/r.length*100):0;return{label:Y(a,"YYYY-MM").format("MMM"),pct:s}})}function tr(t,e=90){let n=0,a=Y();for(let r=0;r<e;r++){let s=Ua(a);if(t.get(s))n++;else break;a.subtract(1,"day")}return n}function er(t,e,n){let a=t.createDiv({cls:"habit-monthly-summary"});a.createEl("p").innerHTML=`<strong>\u{1F525} Current streak: ${n} day${n===1?"":"s"}</strong>`;let r=a.createDiv({cls:"month-bars"});e.forEach(({label:s,pct:o},l)=>{let i=r.createDiv({cls:"month-row"});i.innerHTML=`
      <div class="month-label">${s}</div>
      <div class="bar-track">
        <div class="bar-fill ${l===0?"bar-orange":"bar-purple"}" style="width:${o}%;"></div>
      </div>
      <div class="pct-text">${o}<span class="pct-symbol">%</span></div>
    `})}function ze(t,e,n,a){let r=f=>Y(f).format("YYYY-MM-DD"),s=n.clone().startOf("isoWeek"),o=a.clone().endOf("isoWeek"),l=[...e.keys()].sort(),i=null;for(let f=l.length-1;f>=0;f--){let T=l[f];if(!Y(T).isAfter(a)){if(Y(T).isBefore(n))break;if(e.get(T)){i=T;break}}}let c=t.createDiv({cls:"weekly-streak-wrap"}),d=c.createDiv({cls:"weekly-streak-head"});["Mon","Tue","Wed","Thu","Fri","Sat","Sun"].forEach(f=>d.createDiv({cls:"head",text:f}));let u=c.createDiv({cls:"weekly-streak-grid"}),h=[],p=o.clone().endOf("isoWeek");for(;p.isSameOrAfter(s);){let f=p.clone().startOf("isoWeek");h.push({weekStart:f.clone(),weekEnd:p.clone()}),p.subtract(1,"week")}for(let f of h){let T=f.weekStart.clone();for(let g=0;g<7;g++){let k=r(T),x=T.isSameOrAfter(n)&&T.isSameOrBefore(a),m=x?!!e.get(k):!1,b=u.createDiv({cls:"weekly-streak-cell"});x||b.classList.add("pad"),m&&x&&(b.classList.add("hit"),k===i&&b.classList.add("latest-hit")),b.createDiv({cls:"num",text:x?T.format("D"):""}),b.createDiv({cls:"mmm",text:x?T.format("MMM"):""}),b.setAttr("title",x?`${T.format("ddd, DD MMM YYYY")} ${m?"\u2705 Done":"\u274C Missed"}`:""),T.add(1,"day")}}}function nr(t,e,n){let a=t.createDiv({cls:"month-switch"});return e.forEach((r,s)=>{let o=a.createEl("button",{text:r.label,cls:"month-btn"});s===0&&o.classList.add("active"),o.addEventListener("click",()=>{a.querySelectorAll(".month-btn").forEach(l=>l.classList.remove("active")),o.classList.add("active"),n(r.key)})}),a}function ar(t){let e=document.createElement("style");e.textContent=`
.habit-monthly-summary { margin:.75rem 0 1rem; }
.month-bars { display:flex; flex-direction:column; gap:10px; max-width:560px; }
.month-row { display:flex; align-items:center; gap:12px; width:100%; }
.month-label { width: 4ch; text-align: right; font-weight: 600; font-size: .95em; white-space: nowrap; }
.month-switch { display:flex; gap:8px; margin:.5rem 0 .35rem; }
.month-btn { font-size:.85em; padding:4px 8px; border-radius:8px; cursor:pointer; background: var(--background-modifier-border); border: none; }
.month-btn.active { background: var(--interactive-accent); color: white; }
.bar-track { position:relative; flex:1; height:14px; border-radius:10px; overflow:hidden; background: color-mix(in srgb, var(--background-modifier-border) 35%, transparent); }
.bar-fill { position:absolute; top:0; left:0; bottom:0; border-radius:10px; background: var(--interactive-accent); }
.bar-fill.bar-orange { background:#f4b56a; }
.pct-text { display:flex; align-items:baseline; gap:1px; font-weight:600; font-size:1.05em; white-space:nowrap; }
.pct-symbol { font-size:.8em; line-height:1; }
.weekly-streak-wrap { margin-top:.25rem; }
.weekly-streak-head { display:grid; grid-template-columns: repeat(7, 1fr); gap:6px; max-width:520px; margin-bottom:6px; }
.weekly-streak-head .head { text-align:center; font-size:.75em; color: var(--text-faint); }
.weekly-streak-grid { display:grid; grid-template-columns: repeat(7, 1fr); gap:6px; max-width:520px; }
.weekly-streak-cell { aspect-ratio:1/1; border-radius:10px; background: var(--background-modifier-border); display:flex; flex-direction:column; align-items:center; justify-content:center; padding-top:4px; }
.weekly-streak-cell .num { font-weight:700; font-size:.95em; color: var(--text-muted); line-height:1.1; }
.weekly-streak-cell .mmm { font-size:.7em; color: var(--text-faint); line-height:1.1; margin-top:2px; }
.weekly-streak-cell.hit { background: var(--interactive-accent); }
.weekly-streak-cell.hit .num, .weekly-streak-cell.hit .mmm { color:white; }
.weekly-streak-cell.latest-hit { background:#f4b56a !important; }
.weekly-streak-cell.latest-hit .num, .weekly-streak-cell.latest-hit .mmm { color:white; }
.weekly-streak-cell.pad { opacity:.35; }
`,t.appendChild(e)}async function Qe(t,e,n){e.replaceChildren();let a=await Xa(t,n),r=Va(a),s=Ja(r),o=Za(s),l=tr(s);ar(e),er(e,o,l);let c=Array.from(new Set([...s.keys()].map(u=>Y(u).format("YYYY-MM")))).sort().slice(-3).reverse().map(u=>({key:u,label:Y(u,"YYYY-MM").format("MMM")})),d=c[0]?.key;if(nr(e,c,u=>{d=u,e.querySelectorAll(".weekly-streak-wrap").forEach(f=>f.remove());let{start:h,end:p}=Ke(u);ze(e,s,h,p)}),d){let{start:u,end:h}=Ke(d);ze(e,s,u,h)}}function rr(t,e,n){let a=(()=>{let s=null;return()=>{s&&window.clearTimeout(s),s=window.setTimeout(async()=>{s=null,await Qe(t.app,e,n)},120)}})();class r extends vt.MarkdownRenderChild{onload(){this.registerEvent(t.app.vault.on("modify",o=>{o?.path===n.sourcePath&&a()})),this.registerEvent(t.app.metadataCache.on("changed",o=>{o?.path===n.sourcePath&&a()})),this.registerEvent(t.app.metadataCache.on("resolved",()=>a())),this.registerEvent(t.app.workspace.on("editor-change",()=>a()))}}n.addChild(new r(e))}function Xe(t){let e=async(n,a,r)=>{await Qe(t.app,a,r),rr(t,a,r)};t.registerMarkdownCodeBlockProcessor("wishmap-habit-monthly",e),t.registerMarkdownCodeBlockProcessor("mindmapos-habit-monthly",e)}var kt=require("obsidian");var Qt=class extends kt.SuggestModal{constructor(n){super(n.app);this.plugin=n;this.setPlaceholder("Search or open a periodic note\u2026")}getSuggestions(n){let a=[{label:"Open Today (Daily)",action:async()=>{await ct(this.app)}},{label:"Open This Week (Weekly)",action:async()=>{await Bt(this.app)}},{label:"Open This Month (Monthly)",action:async()=>{await It(this.app)}},{label:"Open This Quarter",action:async()=>{await qt(this.app)}},{label:"Open This Year",action:async()=>{await Gt(this.app)}}],r=n.trim().toLowerCase();return r?a.filter(s=>s.label.toLowerCase().includes(r)):a}renderSuggestion(n,a){a.createDiv({text:n.label})}async onChooseSuggestion(n){await n.action()}};function Ve(t){t.addRibbonIcon("calendar-clock","WishMap: Periodic Notes",n=>{let a=new kt.Menu;a.addItem(r=>r.setTitle("Open Today (Daily)").onClick(async()=>{await ct(t.app)})),a.addItem(r=>r.setTitle("Open This Week (Weekly)").onClick(async()=>{await Bt(t.app)})),a.addItem(r=>r.setTitle("Open This Month (Monthly)").onClick(async()=>{await It(t.app)})),a.addItem(r=>r.setTitle("Open This Quarter").onClick(async()=>{await qt(t.app)})),a.addItem(r=>r.setTitle("Open This Year").onClick(async()=>{await Gt(t.app)})),a.showAtMouseEvent(n)}).setAttr("aria-label","WishMap: Periodic Notes"),t.addCommand({id:"wishmap-open-periodic-notes",name:"Open Periodic Note\u2026",callback:()=>new Qt(t).open()})}var Jt=require("obsidian");var Z=require("obsidian");async function Je(t,e,n){let a=t.vault.getAbstractFileByPath(e);if(!(a instanceof Z.TFile))return;let r=await t.vault.read(a),s=r.match(/^---\r?\n([\s\S]*?)\r?\n---\r?\n?/),o=r,l={};if(s){try{l=(0,Z.parseYaml)(s[1])??{}}catch{l={}}o=r.slice(s[0].length)}for(let[d,u]of Object.entries(n))u!==void 0&&(l[d]=u);let c=`---
${(0,Z.stringifyYaml)(l).trimEnd()}
---
${o}`;c!==r&&await t.vault.modify(a,c)}function Zt(t){return t.toLowerCase().trim().replace(/^[^a-z0-9]+/,"")}function I(t,e){let n=Zt(e.basename);return/^project(\s|:|-|_)/.test(n)}function G(t,e){let n=Zt(e.basename);return/^task(\s|:|-|_)/.test(n)}function q(t,e){let n=Zt(e.basename);return/^goal(\s|:|-|_)/.test(n)}function Ze(t,e){let a=t.metadataCache.getFileCache(e)?.links??[],r=new Set,s=[];for(let o of a){let l=t.metadataCache.getFirstLinkpathDest(o.link,e.path);l instanceof Jt.TFile&&l.extension==="md"&&(r.has(l.path)||(r.add(l.path),s.push(l)))}return s}function tn(t,e){return Ze(t,e).filter(n=>G(t,n))}function sr(t,e){return Ze(t,e).filter(n=>I(t,n))}function Vt(t,e){let n=t.metadataCache.getFileCache(e)?.frontmatter??{},a=["duration_hours","durationHours","duration","duration hours"];for(let r of a)if(n[r]!==void 0){let s=(typeof n[r]=="string",Number(n[r]));if(Number.isFinite(s))return s}return 0}async function en(t,e,n,a){let r=t.metadataCache.getFileCache(e)?.frontmatter?.[n],s=Number(r),o=Math.round(a*10)/10;Number.isFinite(s)&&Math.abs(s-o)<.05||await Je(t,e.path,{[n]:o})}async function dt(t,e){if(!I(t,e))return;let n=tn(t,e),a=0;for(let r of n)a+=Vt(t,r);await en(t,e,"duration_hours",a)}async function te(t,e){if(!q(t,e))return;let n=sr(t,e),a=tn(t,e),r=0;for(let s of n)r+=Vt(t,s);for(let s of a)r+=Vt(t,s);await en(t,e,"duration_hours",r)}function Xt(t,e,n){let a=[],r=t.metadataCache.resolvedLinks,s=new Set;for(let[o,l]of Object.entries(r)){if(!l[e.path])continue;let i=t.vault.getAbstractFileByPath(o);i instanceof Jt.TFile&&i.extension==="md"&&n(t,i)&&(s.has(i.path)||(s.add(i.path),a.push(i)))}return a}function j(t,e){if(I(t,e))return[e,...Xt(t,e,q)];if(G(t,e)){let n=Xt(t,e,I),a=Xt(t,e,q);return[...n,...a]}return q(t,e)?[e]:[]}var nn=require("obsidian");function ee(t){let{app:e}=t;console.log("[WishMap] rollup auto: wiring listeners");let n=new Map;function a(s){let o=s.path,l=n.get(o);l&&window.clearTimeout(l);let i=window.setTimeout(async()=>{if(n.delete(o),I(e,s)){await dt(e,s);for(let c of j(e,s).filter(d=>q(e,d)))await te(e,c)}else q(e,s)&&await te(e,s)},300);n.set(o,i)}function r(s){if(s instanceof nn.TFile&&s.extension==="md"){console.log("[WishMap] rollup auto: file change",s.path);for(let o of j(e,s))a(o)}}t.registerEvent(e.metadataCache.on("changed",r)),t.registerEvent(e.vault.on("modify",r)),t.registerEvent(e.vault.on("create",r)),t.registerEvent(e.vault.on("rename",r)),t.registerEvent(e.vault.on("delete",r)),t.addCommand({id:"wishmap-rollup-current",name:"Recompute duration for current note",checkCallback:s=>{let o=e.workspace.getActiveFile();return!o||o.extension!=="md"?!1:(s||a(o),!0)}}),e.workspace.onLayoutReady(()=>{let s=e.vault.getMarkdownFiles();for(let o of s)for(let l of j(e,o))a(l)})}var _=require("obsidian"),At="03 SaveBox/Active",or=["duration_hours","durationHours","duration","duration hours"],ir=2;function Q(t){return t.toLowerCase().trim().replace(/^[^a-z0-9]+/,"")}var Ft=t=>/^area(\s|:|-|_)/.test(Q(t.basename)),ut=t=>/^wish(\s|:|-|_)/.test(Q(t.basename)),ht=t=>/^goal(\s|:|-|_)/.test(Q(t.basename)),X=t=>/^project(\s|:|-|_)/.test(Q(t.basename)),at=t=>/^task(\s|:|-|_)/.test(Q(t.basename)),ft=t=>/^habit(\s|:|-|_)/.test(Q(t.basename)),pt=t=>/^note(\s|:|-|_)/.test(Q(t.basename)),cr=t=>t.path===At||t.path.startsWith(At+"/"),$=t=>t.vault.getMarkdownFiles().filter(cr),y=(t,e)=>t.basename.localeCompare(e.basename),U=(t,e)=>t.metadataCache.getFileCache(e),ne=(t,e)=>U(t,e)?.frontmatter??{};function lr(t){let e=Number(String(t??"").replace(/[^0-9.\-]/g,""));return Number.isFinite(e)?e:NaN}function H(t,e){for(let n of or)if(ne(t,e)[n]!==void 0){let a=lr(ne(t,e)[n]);if(Number.isFinite(a))return a}return NaN}function dr(t,e){let n=new Set;for(let r of U(t,e)?.tags??[])n.add(String(r?.tag??r).replace(/^#/,""));let a=ne(t,e).tags;return Array.isArray(a)?a.forEach(r=>r&&n.add(String(r).replace(/^#/,""))):a&&n.add(String(a).replace(/^#/,"")),Array.from(n)}var w=(t,e)=>{let n=dr(t,e);return n.length?" "+n.map(a=>`#${a}`).join(" "):""},$t=t=>Number(t.toFixed(ir)),S=t=>`${$t(t)} ${$t(t)===1?"hr":"hrs"}`,P=t=>`<span class="duration-chip">${t}</span>`,A=(t,e)=>e?`<span class="grey-link">~~${t}~~ \u2705</span>`:t;function W(t,e){let n=e.split(`
`).map(a=>a?`> ${a}`:">").join(`
`);return`> [!wishmap]+ ${t}
>
${n}
`}function an(){return`
.duration-chip{display:inline-block;padding:0 6px;border-radius:12px;line-height:1.6;font-size:0.9em;background-color:var(--interactive-accent-hover);color:var(--background-primary);}
.grey-link a{color:var(--text-faint)!important;}
.callout[data-callout="wishmap"] .callout-icon{display:none;} /* hide icon */
`}function rn(t,e){let n=U(t,e)?.links??[],a=new Set,r=[];for(let s of n){let o=t.metadataCache.getFirstLinkpathDest(s.link,e.path);o instanceof _.TFile&&o.extension==="md"&&!a.has(o.path)&&(a.add(o.path),r.push(o))}return r}var M=(t,e,n)=>rn(t,e).some(a=>a.path===n.path)||rn(t,n).some(a=>a.path===e.path),ur=(t,e)=>$(t).filter(ut).filter(n=>M(t,e,n)),on=(t,e)=>$(t).filter(ht).filter(n=>M(t,e,n)),tt=(t,e)=>$(t).filter(X).filter(n=>M(t,e,n)),K=(t,e)=>$(t).filter(at).filter(n=>M(t,e,n)),Mt=(t,e)=>$(t).filter(ft).filter(n=>M(t,e,n)),hr=(t,e)=>$(t).filter(pt).filter(n=>M(t,e,n)),cn=(t,e)=>$(t).filter(pt).filter(n=>M(t,e,n)),ae=(t,e)=>$(t).filter(pt).filter(n=>M(t,e,n)),St=(t,e)=>$(t).filter(pt).filter(n=>M(t,e,n)),z=(t,e)=>$(t).filter(pt).filter(n=>M(t,e,n)),fr=(t,e)=>$(t).filter(X).filter(n=>M(t,e,n)),pr=(t,e)=>$(t).filter(at).filter(n=>M(t,e,n)),mr=(t,e)=>$(t).filter(ft).filter(n=>M(t,e,n)),gr=(t,e)=>$(t).filter(X).filter(n=>M(t,e,n)),yr=(t,e)=>$(t).filter(at).filter(n=>M(t,e,n)),wr=(t,e)=>$(t).filter(ft).filter(n=>M(t,e,n)),br=(t,e)=>$(t).filter(at).filter(n=>M(t,e,n)),Tr=(t,e)=>$(t).filter(ft).filter(n=>M(t,e,n));function et(t,e){let n=K(t,e).map(s=>({d:H(t,s),done:F(t,s)})).filter(s=>Number.isFinite(s.d)&&s.d>0),a=n.reduce((s,o)=>s+o.d,0),r=n.filter(s=>s.done).reduce((s,o)=>s+o.d,0);return a<=0?{total:null,pct:null}:{total:$t(a),pct:Math.round(r/a*100)}}var nt=(t,e)=>K(t,e).length>0&&K(t,e).every(n=>F(t,n));function ln(t,e){let n=tt(t,e),a=0,r=0,s=!1;for(let o of n){let{total:l,pct:i}=et(t,o);Number.isFinite(l)&&l>0&&(s=!0,a+=l,i!=null&&(r+=l*(i/100)))}return!s||a<=0?{total:null,pct:null}:{total:$t(a),pct:Math.round(r/a*100)}}var dn=(t,e)=>tt(t,e).length>0&&tt(t,e).every(n=>nt(t,n));function F(t,e){let a=(U(t,e)?.listItems??[]).find(r=>r&&"task"in r);return String(a?.task??"").toLowerCase()==="x"}function re(t,e){let n=new Set,a=[];a.push(`- [[${e.path}|${e.basename}]]${w(t,e)}`);for(let r of ur(t,e).sort(y))if(!n.has(r.path)){n.add(r.path),a.push(`  - [[${r.path}|${r.basename}]]${w(t,r)}`);for(let s of on(t,r).sort(y)){if(n.has(s.path))continue;n.add(s.path);let{total:o,pct:l}=ln(t,s),i=dn(t,s),c=Number.isFinite(o)&&o>0?` ${P(S(o))}`:"",d=l!=null&&l>0&&l<100?` ${l}%`:"",u=`[[${s.path}|${s.basename}]]${c}${d}${w(t,s)}`;a.push(`    - ${A(u,i)}`);for(let h of tt(t,s).sort(y)){if(n.has(h.path))continue;n.add(h.path);let{total:p,pct:f}=et(t,h),T=nt(t,h),g=Number.isFinite(p)&&p>0?` ${P(S(p))}`:"",k=f!=null&&f>0&&f<100?` ${f}%`:"",x=`[[${h.path}|${h.basename}]]${g}${k}${w(t,h)}`;a.push(`      - ${A(x,T)}`);for(let m of K(t,h).sort(y)){if(n.has(m.path))continue;n.add(m.path);let b=H(t,m),L=Number.isFinite(b)&&b>0?` ${P(S(b))}`:"",E=`[[${m.path}|${m.basename}]]${L}${w(t,m)}`;a.push(`        - ${A(E,F(t,m))}`)}for(let m of Mt(t,h).sort(y)){if(n.has(m.path))continue;n.add(m.path);let b=`[[${m.path}|${m.basename}]]${w(t,m)}`;a.push(`        - ${A(b,F(t,m))}`)}for(let m of St(t,h).sort(y))n.has(m.path)||(n.add(m.path),a.push(`        - [[${m.path}|${m.basename}]]${w(t,m)}`))}for(let h of ae(t,s).sort(y))n.has(h.path)||(n.add(h.path),a.push(`    - [[${h.path}|${h.basename}]]${w(t,h)}`))}for(let s of cn(t,r).sort(y))n.has(s.path)||(n.add(s.path),a.push(`  - [[${s.path}|${s.basename}]]${w(t,s)}`))}for(let r of fr(t,e).sort(y)){if(n.has(r.path))continue;n.add(r.path);let{total:s,pct:o}=et(t,r),l=Number.isFinite(s)&&s>0?` ${P(S(s))}`:"",i=o!=null&&o>0&&o<100?` ${o}%`:"";a.push(`  - ${A(`[[${r.path}|${r.basename}]]${l}${i}${w(t,r)}`,nt(t,r))}`)}for(let r of pr(t,e).sort(y)){if(n.has(r.path))continue;n.add(r.path);let s=H(t,r),o=Number.isFinite(s)&&s>0?` ${P(S(s))}`:"";a.push(`  - ${A(`[[${r.path}|${r.basename}]]${o}${w(t,r)}`,F(t,r))}`)}for(let r of mr(t,e).sort(y))n.has(r.path)||(n.add(r.path),a.push(`  - ${A(`[[${r.path}|${r.basename}]]${w(t,r)}`,F(t,r))}`));for(let r of hr(t,e).sort(y))n.has(r.path)||(n.add(r.path),a.push(`  - [[${r.path}|${r.basename}]]${w(t,r)}`));return W(`${e.basename}`,a.join(`
`))}function un(t,e){let n=new Set,a=[];a.push(`- [[${e.path}|${e.basename}]]${w(t,e)}`);for(let r of on(t,e).sort(y)){if(n.has(r.path))continue;n.add(r.path);let{total:s,pct:o}=ln(t,r),l=dn(t,r),i=Number.isFinite(s)&&s>0?` ${P(S(s))}`:"",c=o!=null&&o>0&&o<100?` ${o}%`:"";a.push(`  - ${A(`[[${r.path}|${r.basename}]]${i}${c}${w(t,r)}`,l)}`);for(let d of tt(t,r).sort(y)){if(n.has(d.path))continue;n.add(d.path);let{total:u,pct:h}=et(t,d),p=nt(t,d),f=Number.isFinite(u)&&u>0?` ${P(S(u))}`:"",T=h!=null&&h>0&&h<100?` ${h}%`:"";a.push(`    - ${A(`[[${d.path}|${d.basename}]]${f}${T}${w(t,d)}`,p)}`);for(let g of K(t,d).sort(y)){if(n.has(g.path))continue;n.add(g.path);let k=H(t,g),x=Number.isFinite(k)&&k>0?` ${P(S(k))}`:"";a.push(`      - ${A(`[[${g.path}|${g.basename}]]${x}${w(t,g)}`,F(t,g))}`);for(let m of z(t,g).sort(y))n.has(m.path)||(n.add(m.path),a.push(`        - [[${m.path}|${m.basename}]]${w(t,m)}`))}for(let g of Mt(t,d).sort(y))n.has(g.path)||(n.add(g.path),a.push(`      - ${A(`[[${g.path}|${g.basename}]]${w(t,g)}`,F(t,g))}`));for(let g of St(t,d).sort(y))n.has(g.path)||(n.add(g.path),a.push(`      - [[${g.path}|${g.basename}]]${w(t,g)}`))}for(let d of ae(t,r).sort(y))n.has(d.path)||(n.add(d.path),a.push(`  - [[${d.path}|${d.basename}]]${w(t,d)}`))}for(let r of gr(t,e).sort(y)){if(n.has(r.path))continue;n.add(r.path);let{total:s,pct:o}=et(t,r),l=Number.isFinite(s)&&s>0?` ${P(S(s))}`:"",i=o!=null&&o>0&&o<100?` ${o}%`:"";a.push(`  - ${A(`[[${r.path}|${r.basename}]]${l}${i}${w(t,r)}`,nt(t,r))}`)}for(let r of yr(t,e).sort(y)){if(n.has(r.path))continue;n.add(r.path);let s=H(t,r),o=Number.isFinite(s)&&s>0?` ${P(S(s))}`:"";a.push(`  - ${A(`[[${r.path}|${r.basename}]]${o}${w(t,r)}`,F(t,r))}`);for(let l of z(t,r).sort(y))n.has(l.path)||(n.add(l.path),a.push(`    - [[${l.path}|${l.basename}]]${w(t,l)}`))}for(let r of wr(t,e).sort(y))n.has(r.path)||(n.add(r.path),a.push(`  - ${A(`[[${r.path}|${r.basename}]]${w(t,r)}`,F(t,r))}`));for(let r of cn(t,e).sort(y))n.has(r.path)||(n.add(r.path),a.push(`  - [[${r.path}|${r.basename}]]${w(t,r)}`));return W(`${e.basename}`,a.join(`
`))}function hn(t,e){let n=new Set,a=[];a.push(`- [[${e.path}|${e.basename}]]${w(t,e)}`);for(let r of tt(t,e).sort(y)){if(n.has(r.path))continue;n.add(r.path);let{total:s,pct:o}=et(t,r),l=Number.isFinite(s)&&s>0?` ${P(S(s))}`:"",i=o!=null&&o>0&&o<100?` ${o}%`:"";a.push(`  - ${A(`[[${r.path}|${r.basename}]]${l}${i}${w(t,r)}`,nt(t,r))}`);for(let c of K(t,r).sort(y)){if(n.has(c.path))continue;n.add(c.path);let d=H(t,c),u=Number.isFinite(d)&&d>0?` ${P(S(d))}`:"";a.push(`    - ${A(`[[${c.path}|${c.basename}]]${u}${w(t,c)}`,F(t,c))}`);for(let h of z(t,c).sort(y))n.has(h.path)||(n.add(h.path),a.push(`      - [[${h.path}|${h.basename}]]${w(t,h)}`))}for(let c of Mt(t,r).sort(y))n.has(c.path)||(n.add(c.path),a.push(`    - ${A(`[[${c.path}|${c.basename}]]${w(t,c)}`,F(t,c))}`));for(let c of St(t,r).sort(y))n.has(c.path)||(n.add(c.path),a.push(`    - [[${c.path}|${c.basename}]]${w(t,c)}`))}for(let r of br(t,e).sort(y)){if(n.has(r.path))continue;n.add(r.path);let s=H(t,r),o=Number.isFinite(s)&&s>0?` ${P(S(s))}`:"";a.push(`  - ${A(`[[${r.path}|${r.basename}]]${o}${w(t,r)}`,F(t,r))}`);for(let l of z(t,r).sort(y))n.has(l.path)||(n.add(l.path),a.push(`    - [[${l.path}|${l.basename}]]${w(t,l)}`))}for(let r of Tr(t,e).sort(y))n.has(r.path)||(n.add(r.path),a.push(`  - ${A(`[[${r.path}|${r.basename}]]${w(t,r)}`,F(t,r))}`));for(let r of ae(t,e).sort(y))n.has(r.path)||(n.add(r.path),a.push(`  - [[${r.path}|${r.basename}]]${w(t,r)}`));return W(`${e.basename}`,a.join(`
`))}function fn(t,e){let n=[];n.push(`- [[${e.path}|${e.basename}]]${w(t,e)}`);for(let a of K(t,e).sort(y)){let r=H(t,a),s=Number.isFinite(r)&&r>0?` ${P(S(r))}`:"";n.push(`  - ${A(`[[${a.path}|${a.basename}]]${s}${w(t,a)}`,F(t,a))}`);for(let o of z(t,a).sort(y))n.push(`    - [[${o.path}|${o.basename}]]${w(t,o)}`)}for(let a of Mt(t,e).sort(y))n.push(`  - ${A(`[[${a.path}|${a.basename}]]${w(t,a)}`,F(t,a))}`);for(let a of St(t,e).sort(y))n.push(`  - [[${a.path}|${a.basename}]]${w(t,a)}`);return W(`${e.basename}`,n.join(`
`))}function xr(t,e){let n=[],a=H(t,e),r=Number.isFinite(a)&&a>0?` ${P(S(a))}`:"";n.push(`- ${A(`[[${e.path}|${e.basename}]]${r}${w(t,e)}`,F(t,e))}`);for(let s of z(t,e).sort(y))n.push(`  - [[${s.path}|${s.basename}]]${w(t,s)}`);return W(`${e.basename}`,n.join(`
`))}function sn(t){return Ft(t)?0:ut(t)?1:ht(t)?2:X(t)?3:99}function vr(t,e,n){let a=U(t,e)?.links??[],r=U(t,n)?.links??[],s=a.some(l=>t.metadataCache.getFirstLinkpathDest(l.link,e.path)?.path===n.path),o=r.some(l=>t.metadataCache.getFirstLinkpathDest(l.link,n.path)?.path===e.path);return s||o}function kr(t,e){let n=m=>(U(t,m)?.links??[]).length>0,a=m=>{for(let[,b]of Object.entries(t.metadataCache.resolvedLinks))if(b[m.path])return!0;return!1},r=m=>!n(m)&&!a(m),s=m=>{let b=sn(m);return b===0?!1:$(t).filter(E=>sn(E)<b).some(E=>vr(t,E,m))},o=m=>!s(m),l=e.filter(ut).sort(y),i=e.filter(ht).sort(y),c=e.filter(X).sort(y),d=e.filter(at).sort(y),u=e.filter(ft).sort(y),h=m=>m.map(b=>`- [[${b.path}|${b.basename}]]`).join(`
`),p=(m,b)=>b.length?W(`${m} (${b.length})`,h(b)):"",f=m=>m.sort(y).map(b=>Ar(t,b)).join(`

`),T=(m,b)=>b.length?W(`${m} (${b.length})`,f(b)):"",g=d.filter(m=>r(m)||o(m)),k="";if(g.length){let m=[];for(let b of g.sort(y)){let L=H(t,b),E=Number.isFinite(L)&&L>0?` ${P(S(L))}`:"";m.push(`- ${A(`[[${b.path}|${b.basename}]]${E}${w(t,b)}`,F(t,b))}`);for(let st of z(t,b).sort(y))m.push(`  - [[${st.path}|${st.basename}]]${w(t,st)}`)}k=W(`\u{1F4CC} Solo Tasks (${g.length})`,m.join(`
`))}let x=[];return x.push(T("\u{1F4AD} Unparented Wishes",l.filter(o))),x.push(T("\u{1F3AF} Unparented Goals",i.filter(o))),x.push(T("\u{1F680} Unparented Projects",c.filter(o))),x.push(k),x.push(p("\u{1F501} Solo Habits",u.filter(m=>r(m)||o(m)))),x.push(p("\u{1F4AD} Standalone Wishes",l.filter(r))),x.push(p("\u{1F3AF} Standalone Goals",i.filter(r))),x.push(p("\u{1F680} Standalone Projects",c.filter(r))),x.filter(Boolean).join(`

`)}function Ar(t,e){if(Ft(e))return re(t,e);if(ut(e))return un(t,e);if(ht(e))return hn(t,e);if(X(e))return fn(t,e);let n=w(t,e);return W(`\u{1F4C4} ${e.basename}`,`- [[${e.path}|${e.basename}]]${n}`)}function pn(t){let e=t.app;t.registerMarkdownCodeBlockProcessor("wishmap",async(n,a,r)=>{a.empty(),a.createEl("style",{text:an()});let s=await mn(e);await _.MarkdownRenderer.render(e,s,a,r.sourcePath,t)}),t.registerMarkdownCodeBlockProcessor("wishmap-local",async(n,a,r)=>{let s=String(n||"").trim().toLowerCase(),o=e.vault.getAbstractFileByPath(r.sourcePath);if(!(o instanceof _.TFile)||o.extension!=="md"){a.setText("No file context");return}a.empty(),a.createEl("style",{text:an()});let l="";s==="project"||!s&&X(o)?l=fn(e,o):s==="goal"||!s&&ht(o)?l=hn(e,o):s==="wish"||!s&&ut(o)?l=un(e,o):s==="area"||!s&&Ft(o)?l=re(e,o):s==="task"||!s&&at(o)?l=xr(e,o):l="_Place in an Area, Wish, Goal, Project, or Task note, or pass one of: area | wish | goal | project | task._",await _.MarkdownRenderer.render(e,l,a,r.sourcePath,t)})}async function mn(t){let e=$(t),n=e.filter(Ft).sort(y),a=[];for(let r of n)a.push(re(t,r));return a.push(kr(t,e)),a.filter(Boolean).join(`

`)}async function gn(t){let e=await mn(t),n=(0,_.normalizePath)(`${At}/_Maps/Area-Maps.md`),a=t.vault.getAbstractFileByPath(n);if(a instanceof _.TFile)await t.vault.read(a)!==e&&await t.vault.modify(a,e);else{try{await t.vault.createFolder(`${At}/_Maps`)}catch{}await t.vault.create(n,e)}return n}var C=require("obsidian");var $r=/^(?:Y)?\d{4}$/;function Fr(t){return t?(Array.isArray(t?.tags)?t.tags:typeof t?.tags=="string"?[t.tags]:Array.isArray(t?.tag)?t.tag:typeof t?.tag=="string"?[t.tag]:[]).map(String):[]}function se(t){return Fr(t).map(e=>e.trim()).filter(e=>$r.test(e)).map(e=>e.replace(/^Y/,"")).filter(e=>/^\d{4}$/.test(e))}function Mr(){if(document.getElementById("wm-area-cols-style"))return;let t=`
/* hide elements programmatically */
.wm-hidden { display: none !important; }

/* Show a light-purple bubble after scheduled links in \u201CMy Wishes\u201D */
a.internal-link.wm-wish-link--scheduled::after {
  content: "#Y" attr(data-year);
  display: inline-block;
  margin-left: 6px;
  padding: 2px 8px 3px 8px;
  border-radius: 999px;
  font-size: 0.8em;
  font-weight: 600;
  line-height: 1;
  background: color-mix(in srgb, var(--text-accent) 20%, var(--background-primary));
  color: var(--text-accent);
  vertical-align: middle;
}



/* Hide link preview popovers while dragging */
body.wm-dragging .popover,
body.wm-dragging .mod-hover-popover,
body.wm-drag-intent .popover,
body.wm-drag-intent .mod-hover-popover {
  display: none !important;
  opacity: 0 !important;
  pointer-events: none !important;
}

/* grid */
.wm-year-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-top: 6px;
}
.wm-year-col {
  border: 0;
  background: transparent;
}

/* header: slightly darker grey than body */
.wm-year-col--header {
  padding: 10px 12px;
  font-weight: 700;
  text-align: center;
  background: color-mix(in srgb, var(--background-secondary) 100%, var(--background-primary));
  border: 1px solid color-mix(in srgb, var(--background-secondary) 100%, var(--background-primary));
  border-bottom: 3px solid white;
  color: var(--text-muted);
  font-size: .85em;
  border-radius: 12px 12px 0 0;  /* rounded top corners only */
}

  
/* body: lighter grey, rounded only on bottom corners */
.wm-year-col--body {
  min-height: 140px;
  padding: 10px 12px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  background: color-mix(in srgb, var(--background-secondary) 70%, var(--background-primary));
  border: 1px solid color-mix(in srgb, var(--background-secondary) 70%, var(--background-primary));
  border-top: none;
  border-radius: 0 0 12px 12px;  /* only bottom corners rounded */
}

/* drag over state keeps your accent outline */
.wm-year-col--body.is-dragover {
  outline: 2px dashed var(--text-accent);
  outline-offset: -4px;
}


/* card */
/* card: opaque purple with bold text */
.wm-wish-card {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 12px;
  border-radius: 10px;
  background: var(--interactive-accent);
  border: 1px solid var(--interactive-accent);
  box-shadow: 0 1px 2px rgba(0,0,0,.05);
  cursor: grab;
  user-select: none;
  color: white;
  font-weight: 700;
}
  .wm-wish-card.is-external { opacity: .9; }

/* hide hover popover while dragging */
body.wm-dragging .popover,
body.wm-dragging .mod-hover-popover,
body.wm-drag-intent .popover,
body.wm-drag-intent .mod-hover-popover {
  display: none !important;
}

/* "already scheduled" look for links under My Wishes */
.wm-wish-link--scheduled {
  color: var(--text-faint) !important;
  cursor: default !important;
  text-decoration: none !important;
  /* REMOVE: pointer-events: none; */
}

.wm-scheduled-badge {
  margin-left: 6px;
  padding: 1px 6px;
  border-radius: 6px;
  font-size: .8em;
  color: var(--text-faint);
  background: var(--background-modifier-border);
}

`,e=document.createElement("style");e.id="wm-area-cols-style",e.textContent=t,document.head.appendChild(e)}function Sr(t){return(Array.isArray(t?.tags)?t.tags:t?.tags?[t.tags]:[]).map(String)}function yn(t,e){let r=[...Sr(t).filter(s=>!/^Y\d{4}$/.test(String(s))),`Y${e}`];t.tags=r}var oe="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGNgYAAAAAMAASsJTYQAAAAASUVORK5CYII=";function rt(t){return/^✨\s*Wish\s*-\s*/i.test(t)?"wish":/^🎯\s*Goal\s*-\s*/i.test(t)?"goal":/^🚀\s*Project\s*-\s*/i.test(t)?"project":/^📌\s*Task\s*-\s*/i.test(t)?"task":"other"}var ie=class extends C.MarkdownRenderChild{constructor(n,a,r){super(r);this.appRef=n;this.fileRef=a}pruneScheduledLinksUnderWishes(n){let a=this.findHeaderLoose(n,"wishes");if(!a)return;let r=[];for(let o=a.nextElementSibling;o&&!/^H[1-6]$/.test(o.tagName);o=o.nextElementSibling)r.push(o);r.flatMap(o=>Array.from(o.querySelectorAll("a.internal-link"))).forEach(o=>{let l=o.getAttribute("data-href")||o.getAttribute("href")||o.textContent||"",i=this.appRef.metadataCache.getFirstLinkpathDest(l||"",this.fileRef.path);if(!(i instanceof C.TFile)||rt(i.basename)!=="wish")return;let c=this.appRef.metadataCache.getFileCache(i)?.frontmatter,u=se(c)[0];u?(o.classList.add("wm-wish-link--scheduled"),o.setAttribute("data-year",String(u)),o.setAttribute("draggable","false")):(o.classList.remove("wm-wish-link--scheduled"),o.removeAttribute("data-year"),o.setAttribute("draggable","true"))})}installDragPayloadBridge(n){if(n._wmBridgeBound)return;n._wmBridgeBound=!0;let a=s=>{let o=s,l=o.target;if(!l)return;let i=l.closest("a.internal-link");if(!i||i.classList.contains("wm-wish-link--scheduled"))return;let c=i.getAttribute("data-href")||i.getAttribute("href")||i.textContent||"",d=this.appRef.metadataCache.getFirstLinkpathDest(c||"",this.fileRef.path);if(!(d instanceof C.TFile)||rt(d.basename)!=="wish")return;let u=o.dataTransfer;if(!u)return;u.setData("text/x-wish-path",d.path),u.setData("text/plain",d.path),u.effectAllowed="copyMove";let h=new Image;h.src=oe,u.setDragImage(h,0,0),document.body.classList.add("wm-dragging","wm-drag-intent"),document.querySelectorAll(".popover,.mod-hover-popover").forEach(p=>{let f=p;f.style.display="none",f.style.opacity="0",f.style.pointerEvents="none"}),console.log("[WM][AreaCols] bridge dragstart -> payload set",{path:d.path})},r=()=>{document.body.classList.remove("wm-dragging","wm-drag-intent")};n.addEventListener("dragstart",a,!0),n.addEventListener("dragend",r,!0)}bindMyWishesAnchors(n){let a=this.findHeaderLoose(n,"wishes");if(!a){console.log("[WM][AreaCols] wishes header not found");return}let r=[];for(let o=a.nextElementSibling;o&&!/^H[1-6]$/.test(o.tagName);o=o.nextElementSibling)r.push(o);let s=r.flatMap(o=>Array.from(o.querySelectorAll("a.internal-link")));console.log("[WM][AreaCols] found anchors under wishes:",s.length),s.forEach(o=>{let l=o.getAttribute("data-href")||o.getAttribute("href")||o.textContent||"",i=this.appRef.metadataCache.getFirstLinkpathDest(l||"",this.fileRef.path);if(!(i instanceof C.TFile)||rt(i.basename)!=="wish")return;if(o.classList.contains("wm-wish-link--scheduled")){o.removeAttribute("draggable");return}if(o._wmBound)return;o._wmBound=!0,o.setAttribute("draggable","true");let c=null,d=()=>{c||(c=window.setTimeout(()=>{document.body.classList.add("wm-drag-intent"),console.log("[WM][AreaCols] long press detected on",i.path),document.querySelectorAll(".popover,.mod-hover-popover").forEach(h=>{let p=h;p.style.display="none",p.style.opacity="0",p.style.pointerEvents="none"})},500))},u=()=>{c&&(window.clearTimeout(c),c=null),document.body.classList.remove("wm-drag-intent")};o.addEventListener("mousedown",d),o.addEventListener("touchstart",d,{passive:!0}),["mouseup","mouseleave","touchend","touchcancel"].forEach(h=>o.addEventListener(h,u)),o.addEventListener("dragstart",h=>{console.log("[WM][AreaCols] dragstart initial",{href:l,path:i.path});let p=h.dataTransfer;if(p){p.setData("text/plain",i.path),p.setData("text/x-wish-path",i.path),p.effectAllowed="copyMove";let f=new Image;f.src=oe,p.setDragImage(f,0,0)}document.body.classList.add("wm-dragging","wm-drag-intent"),requestAnimationFrame(()=>{try{h.dataTransfer?.setData("text/x-wish-path",i.path),console.log("[WM][AreaCols] dragstart payload forced",i.path)}catch(f){console.warn("[WM][AreaCols] failed to set dataTransfer payload",f)}})}),o.addEventListener("dragend",()=>{console.log("[WM][AreaCols] dragend"),document.body.classList.remove("wm-dragging","wm-drag-intent"),u()})})}onload(){let n=this.doRender.bind(this);n(),this.registerEvent(this.appRef.metadataCache.on("resolved",()=>{this.appRef.workspace.getActiveFile()?.path===this.fileRef.path&&n()})),this.registerEvent(this.appRef.workspace.on("file-open",a=>{a?.path===this.fileRef.path&&n()})),this.registerEvent(this.appRef.metadataCache.on("changed",()=>{this.appRef.workspace.getActiveFile()?.path===this.fileRef.path&&n()}))}doRender(){Mr();let n=this.containerEl,a=this.findHeaderLoose(n,"yearly schedule")||this.findHeaderLoose(n,"my yearly schedule");if(!a)return;let r=n.querySelector(".wm-year-grid-mount")||this.ensureMountAfter(a,"wm-year-grid-mount");r.innerHTML="";let s=new Date,o=[String(s.getFullYear()),String(s.getFullYear()+1)],l=this.renderYearGrid(o);r.appendChild(l.wrapper),this.pruneScheduledLinksUnderWishes(n),this.bindMyWishesAnchors(n),this.installDragPayloadBridge(n);let i=this.populateWishes(l,o,n);for(let c of o){let d=l.columns[c];if(!d)continue;let u=i[c]??0;d.header.textContent=u>0?`${c} (${u})`:c}}ensureMountAfter(n,a){let r=n.nextElementSibling;if(r&&r.classList.contains(a))return r;let s=document.createElement("div");return s.classList.add(a),n.insertAdjacentElement("afterend",s),s}findHeaderLoose(n,a){let r=l=>l.toLowerCase().replace(/\p{Extended_Pictographic}/gu,"").replace(/[^a-z0-9\s]/g," ").replace(/\s+/g," ").trim(),s=r(a),o=Array.from(n.querySelectorAll("h1,h2,h3,h4,h5,h6"));for(let l of o)if(r(l.textContent||"").includes(s))return l;return null}renderYearGrid(n){let a=document.createElement("div");a.classList.add("wm-year-grid");let r={};for(let s of n){let o=document.createElement("div");o.classList.add("wm-year-col");let l=document.createElement("div");l.classList.add("wm-year-col--header"),l.textContent=s;let i=document.createElement("div");i.classList.add("wm-year-col--body"),i.setAttribute("data-year",s),i.style.pointerEvents="auto",i.style.position="relative",i.addEventListener("dragenter",c=>{console.log("[WM][AreaCols] dragenter",s),i.classList.add("is-dragover");let d=c.dataTransfer;d&&(d.dropEffect="copy"),i.style.boxShadow="inset 0 0 0 2px var(--text-accent)"}),i.addEventListener("dragover",c=>{c.preventDefault(),c.stopPropagation();let d=c.dataTransfer;d&&(d.dropEffect="copy"),i.classList.contains("is-dragover")||(console.log("[WM][AreaCols] dragover -> add highlight",s),i.classList.add("is-dragover"),i.style.boxShadow="inset 0 0 0 2px var(--text-accent)")}),i.addEventListener("drop",async c=>{c.preventDefault(),c.stopPropagation(),i.classList.remove("is-dragover"),i.style.boxShadow="";let d=c.dataTransfer,u=d?.getData("text/x-wish-path")||d?.getData("text/plain")||d?.getData("text/uri-list")||"";if(u&&!u.endsWith(".md")){let h=this.appRef.metadataCache.getFirstLinkpathDest(u,this.fileRef.path);h instanceof C.TFile&&(u=h.path)}u&&(await this.onDropWishToYear(u,s),this.doRender())}),o.appendChild(l),o.appendChild(i),a.appendChild(o),r[s]={root:o,header:l,body:i}}return{wrapper:a,columns:r}}makeCard(n,a,r){let s=document.createElement("div");return s.classList.add("wm-wish-card"),s.textContent=n+(r?"":" \u26A0\uFE0F"),s.setAttribute("draggable","true"),s.dataset.path=a,s.addEventListener("dragstart",o=>{o.dataTransfer?.setData("text/x-wish-path",a),document.body.classList.add("wm-dragging");let l=new Image;l.src=oe,o.dataTransfer?.setDragImage(l,0,0)}),s.addEventListener("dragend",()=>{document.body.classList.remove("wm-dragging")}),s.addEventListener("click",async()=>{let o=this.appRef.vault.getAbstractFileByPath(a);o instanceof C.TFile&&await this.appRef.workspace.getLeaf(!1).openFile(o)}),s}collectWishesFromThisPage(n){let a=this.findHeaderLoose(n,"\u270D\uFE0Fmy wishes")||this.findHeaderLoose(n,"my wishes");if(!a)return[];let r=[];for(let c=a.nextElementSibling;c&&!/^H[1-6]$/.test(c.tagName);c=c.nextElementSibling)r.push(c);let o=r.flatMap(c=>Array.from(c.querySelectorAll("a.internal-link"))).map(c=>c.getAttribute("data-href")||c.getAttribute("href")||c.textContent||"").filter(Boolean),l=this.fileRef.path;return o.map(c=>this.appRef.metadataCache.getFirstLinkpathDest(c,l)).filter(c=>c instanceof C.TFile).filter(c=>rt(c.basename)==="wish").map(c=>c.path)}collectAllWishesWithYear(n,a){return this.appRef.vault.getMarkdownFiles().filter(s=>rt(s.basename)==="wish").filter(s=>{if(a.has(s.path))return!1;let o=this.appRef.metadataCache.getFileCache(s)?.frontmatter;return se(o).includes(n)})}async onDropWishToYear(n,a){let r=this.appRef.vault.getAbstractFileByPath(n);if(r instanceof C.TFile){await this.appRef.fileManager.processFrontMatter(r,s=>{yn(s,String(a))});try{let s=this.appRef.metadataCache.getBacklinksForFile(r)?.data??{};for(let o of Object.keys(s)){let l=this.appRef.vault.getAbstractFileByPath(o);if(!(l instanceof C.TFile))continue;let i=rt(l.basename);(i==="goal"||i==="project"||i==="task"||i==="wish")&&await this.appRef.fileManager.processFrontMatter(l,c=>{yn(c,String(a)),i==="task"&&delete c.due})}}catch(s){console.warn("[WM][areaScheduler] cascade failed",s)}}}populateWishes(n,a,r){let s=Object.fromEntries(a.map(c=>[c,0])),o=Array.from(new Set(this.collectWishesFromThisPage(r))),l=new Set(o),i=new Set;for(let c of o){let d=this.appRef.vault.getAbstractFileByPath(c);if(!(d instanceof C.TFile))continue;let u=this.appRef.metadataCache.getFileCache(d)?.frontmatter,h=se(u),p=d.basename.trim(),f=h.find(T=>a.includes(T));f&&!i.has(d.path)&&(n.columns[f].body.appendChild(this.makeCard(p,d.path,!0)),i.add(d.path),s[f]++)}for(let c of a){let d=this.collectAllWishesWithYear(c,l);for(let u of d){if(i.has(u.path))continue;let h=u.basename.trim(),p=this.makeCard(h,u.path,!0);p.classList.add("is-external"),n.columns[c].body.appendChild(p),i.add(u.path),s[c]++}}return s}},Pt=class{constructor(e){this.app=e}async postProcess(e,n){let a=this.app.vault.getAbstractFileByPath(n.sourcePath);if(!(a instanceof C.TFile)||!/area/i.test(a.basename))return;let r=e.closest(".markdown-reading-view")||e.closest(".markdown-preview-view")||e.closest(".markdown-rendered")||e,s=new ie(this.app,a,r);n.addChild(s)}};var Nt=require("obsidian");var Et=class{constructor(){this.data={nodes:new Map,byType:{area:new Set,wish:new Set,goal:new Set,project:new Set,task:new Set},childrenOf:new Map,observersOf:new Map,unscheduled:{goal:0,project:0,task:0},ready:!1}}reset(){this.data.nodes.clear(),Object.keys(this.data.byType).forEach(e=>this.data.byType[e].clear()),this.data.childrenOf.clear(),this.data.observersOf.clear(),this.data.unscheduled={goal:0,project:0,task:0},this.data.ready=!1}get(){return this.data}markReady(){this.data.ready=!0}isReady(){return this.data.ready}upsertNode(e){this.data.nodes.set(e.path,e),e.type&&this.data.byType[e.type].add(e.path)}removeNode(e){let n=this.data.nodes.get(e);n?.type&&this.data.byType[n.type].delete(e),this.data.nodes.delete(e),this.data.childrenOf.delete(e),this.data.observersOf.delete(e);for(let a of this.data.childrenOf.values())a.delete(e);for(let a of this.data.observersOf.values())a.delete(e)}setPrimaryEdge(e,n){for(let[a,r]of this.data.childrenOf)r.delete(e);n&&(this.data.childrenOf.has(n)||this.data.childrenOf.set(n,new Set),this.data.childrenOf.get(n).add(e))}setObserverEdges(e,n){for(let[a,r]of this.data.observersOf)n.has(a)||r.delete(e);for(let a of n)this.data.observersOf.has(a)||this.data.observersOf.set(a,new Set),this.data.observersOf.get(a).add(e)}getNode(e){return this.data.nodes.get(e)}getByType(e){return[...this.data.byType[e]].map(n=>this.data.nodes.get(n)).filter(Boolean)}getUnscheduledCounts(){return{...this.data.unscheduled}}setUnscheduledCounts(e){this.data.unscheduled=e}};var mt={YEAR:/#year\/(\d{4})/i,QUARTER:/#quarter\/(\d{4}-Q[1-4])/i,MONTH:/#month\/(\d{4})-(\d{2})/i,WEEK:/#week\/(\d{4})-W(\d{2})/i,DUE:/#due\/(\d{4})-(\d{2})-(\d{2})/i};function ce(t){let e={},n=t.match(mt.YEAR);n&&(e.year=n[1]);let a=t.match(mt.QUARTER);a&&(e.quarter=a[1]);let r=t.match(mt.MONTH);r&&(e.month=`${r[1]}-${r[2].padStart(2,"0")}`);let s=t.match(mt.WEEK);s&&(e.week=`${s[1]}-W${s[2].padStart(2,"0")}`);let o=t.match(mt.DUE);return o&&(e.due=`${o[1]}-${o[2].padStart(2,"0")}-${o[3].padStart(2,"0")}`),gt(e)}function wn(t){return t?ce(t):{}}function bn(t){let e=gt(t),n=[];return e.year&&n.push(`#year/${e.year}`),e.quarter&&n.push(`#quarter/${e.quarter}`),e.month&&n.push(`#month/${e.month}`),e.week&&n.push(`#week/${e.week}`),e.due&&n.push(`#due/${e.due}`),`<!-- wishmap: ${n.join(" ")} -->`}function gt(t){let e={};if(t.year&&/^\d{4}$/.test(t.year)&&(e.year=t.year),t.quarter&&/^\d{4}-Q[1-4]$/.test(t.quarter)&&(e.quarter=t.quarter),t.month&&/^\d{4}-\d{1,2}$/.test(t.month)){let[n,a]=t.month.split("-").map(Number);a>=1&&a<=12&&(e.month=`${n}-${String(a).padStart(2,"0")}`)}if(t.week&&/^\d{4}-W\d{1,2}$/.test(t.week)){let[n,a]=t.week.replace("W","").split("-").map(Number);a>=1&&a<=53&&(e.week=`${n}-W${String(a).padStart(2,"0")}`)}if(t.due&&/^\d{4}-\d{1,2}-\d{1,2}$/.test(t.due)){let[n,a,r]=t.due.split("-").map(Number);a>=1&&a<=12&&r>=1&&r<=31&&(e.due=`${n}-${String(a).padStart(2,"0")}-${String(r).padStart(2,"0")}`)}return e}function le(t){let e={due:gt({due:t}).due};if(!e.due)return e;let[n,a,r]=e.due.split("-").map(Number);return e.year=String(n),e.month=`${n}-${String(a).padStart(2,"0")}`,e.quarter=`${n}-Q${Math.floor((a-1)/3)+1}`,e.week=`${n}-W${String(Er(new Date(n,a-1,r))).padStart(2,"0")}`,e}function Tn(t,e){let n=["due","week","month","quarter","year"];for(let a of n){let r=t[a],s=e[a];if(!r&&!s)continue;if(r&&!s)return-1;if(!r&&s)return 1;let o=Pr(a,r,s);if(o!==0)return o}return 0}function Pr(t,e,n){switch(t){case"due":case"week":case"month":return e<n?-1:e>n?1:0;case"quarter":{let[a,r]=e.split("-Q").map(Number),[s,o]=n.split("-Q").map(Number);return a!==s?a<s?-1:1:r<o?-1:r>o?1:0}case"year":{let a=Number(e),r=Number(n);return a<r?-1:a>r?1:0}default:return 0}}function Er(t){let e=new Date(Date.UTC(t.getFullYear(),t.getMonth(),t.getDate()));e.setUTCDate(e.getUTCDate()+4-(e.getUTCDay()||7));let n=new Date(Date.UTC(e.getUTCFullYear(),0,1));return Math.ceil(((e.getTime()-n.getTime())/864e5+1)/7)}function Cr(t){let e=t.trim().match(/^(?:\p{Emoji_Presentation}|\p{Emoji}\uFE0F)/u);return e?e[0]:void 0}function xn(t){let e=Cr(t)||"",n=t.toLowerCase();if(e==="\u{1F331}"||n.startsWith("area "))return"area";if(e==="\u2728"||n.startsWith("wish "))return"wish";if(e==="\u{1F3AF}"||n.startsWith("goal "))return"goal";if(e==="\u{1F680}"||n.startsWith("project "))return"project";if(e==="\u{1F4CC}"||n.startsWith("task "))return"task"}function Ct(t){let e=t.match(/<!--\s*wishmap:\s*([^>]*)-->/i);return e?e[0]:void 0}function vn(t){let e=ce(t),n=wn(Ct(t)??"");return{year:n.year??e.year,quarter:n.quarter??e.quarter,month:n.month??e.month,week:n.week??e.week,due:n.due??e.due}}function kn(t){let e=new Set,n=/^(?:Parents?|Parent)\s*:\s*(.*)$/i,a=t.split(/\r?\n/);for(let r of a){let s=r.match(n);if(!s)continue;let o=s[1].match(/\[\[([^\]]+)\]\]/g)||[];for(let l of o){let i=l.slice(2,-2).trim();i&&e.add(i)}}return e}async function An(t,e){let n=new Set,r=(await t.vault.read(e)).match(/\[\[([^\]]+)\]\]/g)||[];for(let s of r){let o=s.slice(2,-2).trim();o&&n.add(o)}return n}async function Lt(t,e,n){let a=await t.vault.read(e),r=bn(n),s=Ct(a),o=s?a.replace(s,r):a.trimEnd()+`

`+r+`
`;o!==a&&await t.vault.modify(e,o)}async function Fn(t,e){let n=t.metadataCache.getFileCache(e)?.frontmatter??{},a={};if(typeof n.done=="boolean"&&(a.done=n.done),typeof n.status=="string"&&(a.status=n.status),typeof n.impact=="string"&&(a.impact=n.impact),$n(n.duration_hours)&&(a.durationHours=Number(n.duration_hours)),$n(n.budget)&&(a.budget=Number(n.budget)),typeof n.due=="string"){let r=Lr(n.due);r&&(a.due=r)}return a}function $n(t){return typeof t=="number"||typeof t=="string"&&t.trim()!==""&&!Number.isNaN(Number(t))}function Lr(t){let e=t.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);if(e){let a=Number(e[1]),r=String(Number(e[2])).padStart(2,"0"),s=String(Number(e[3])).padStart(2,"0");return`${a}-${r}-${s}`}let n=new Date(t);if(!Number.isNaN(n.getTime())){let a=n.getFullYear(),r=String(n.getMonth()+1).padStart(2,"0"),s=String(n.getDate()).padStart(2,"0");return`${a}-${r}-${s}`}}function Mn(){let t=new Et,e;return{async init(n){e=n,await this.rescanAll(),t.markReady(),console.debug("[WishMap] indexer ready")},async rescanAll(){t.reset();let n=e.vault.getMarkdownFiles();for(let a of n){let r=await de(e,a);r&&t.upsertNode(r)}for(let a of t.get().nodes.values())ue(t,a);t.setUnscheduledCounts(Dt(t))},onFileCreate(n){!(n instanceof Nt.TFile)||n.extension!=="md"||de(e,n).then(a=>{a&&(t.upsertNode(a),ue(t,a),t.setUnscheduledCounts(Dt(t)))})},onFileModify(n){!(n instanceof Nt.TFile)||n.extension!=="md"||de(e,n).then(a=>{a&&(t.upsertNode(a),ue(t,a),t.setUnscheduledCounts(Dt(t)))})},onFileDelete(n){n instanceof Nt.TFile&&(t.removeNode(n.path),t.setUnscheduledCounts(Dt(t)))},getStore(){return t}}}async function de(t,e){let n=e.basename,a=xn(n);if(!a)return;let r=e.stat.mtime,s=await t.vault.read(e),o=vn(s),l=Ct(s),i=await Fn(t,e),c=kn(s);if(c.size===0){let h=await An(t,e);for(let p of h)c.add(p)}let d=new Set;for(let h of c){let p=t.metadataCache.getFirstLinkpathDest(h,e.path);p&&d.add(p.path)}return{path:e.path,basename:n,type:a,parents:d,primaryParent:void 0,secondaryParents:new Set,tags:o,yaml:i,conflicts:[],serviceLine:l,mtime:r}}function ue(t,e){if(!e||!e.type)return;let n=[];for(let s of e.parents){let o=t.getNode(s);o&&Nr(o.type,e.type)&&n.push(o)}if(n.length===0){e.primaryParent=void 0,e.secondaryParents=new Set,t.setPrimaryEdge(e.path,void 0),t.setObserverEdges(e.path,new Set);return}let a=Dr(n);e.primaryParent=a?.path;let r=new Set(n.filter(s=>s.path!==e.primaryParent).map(s=>s.path));e.secondaryParents=r,t.setPrimaryEdge(e.path,e.primaryParent),t.setObserverEdges(e.path,r)}function Dr(t){if(t.length===0)return;let e=t[0];for(let n=1;n<t.length;n++){let a=t[n],r=Tn(e.tags,a.tags);(r>0||r===0&&a.mtime<e.mtime)&&(e=a)}return e}function Nr(t,e){let n=["area","wish","goal","project","task"];return n.indexOf(t)<n.indexOf(e)}function Dt(t){let e=0,n=0,a=0;for(let r of t.get().nodes.values())r.type==="goal"&&!r.tags.year&&e++,r.type==="project"&&!r.tags.quarter&&n++,r.type==="task"&&!r.yaml?.due&&a++;return{goal:e,project:n,task:a}}function Pn(){return{async run(t){for(let e of t.get().nodes.values())await Sn(t,e.path)},async onNodeChange(t,e){await Sn(t,e)}}}async function Sn(t,e){let n=t.getNode(e);if(n){if(n.yaml.due){let a=Or(n);await Rr(t,n,a),n.primaryParent&&await Yr(t,n.path)}n.primaryParent&&await Hr(t,n.primaryParent)}}function Or(t){return le(t.yaml.due)}async function Rr(t,e,n){let a=he(e.tags,n);if(fe(e.tags,a)){e.tags=a;let r=pe(t,e.path);r&&(await Lt(window.app,r,e.tags),console.debug("[WishMap] service tags updated",{path:e.path,tags:e.tags}))}}function he(t,e){let n={...t};return n.due=t.due??e.due,n.week=t.week??e.week,n.month=t.month??e.month,n.quarter=t.quarter??e.quarter,n.year=t.year??e.year,gt(n)}function fe(t,e){return JSON.stringify(t)!==JSON.stringify(e)}async function Yr(t,e){let n=t.getNode(e);if(!n?.yaml.due)return;let a=le(n.yaml.due),r=n.primaryParent?t.getNode(n.primaryParent):void 0;for(;r;){let s={};r.tags.year||(s.year=a.year),r.tags.quarter||(s.quarter=a.quarter),r.tags.month||(s.month=a.month),r.tags.week||(s.week=a.week);let o=he(r.tags,s);if(fe(r.tags,o)){r.tags=o;let l=pe(t,r.path);l&&await Lt(window.app,l,r.tags),console.debug("[WishMap] Auto-filled parent from child due",{parent:r.path,tags:r.tags})}r=r.primaryParent?t.getNode(r.primaryParent):void 0}}async function Hr(t,e){let n=t.getNode(e);if(!n)return;let a=t.get().childrenOf.get(e);if(a?.size)for(let r of a){let s=t.getNode(r);if(!s)continue;let o={};n.tags.year&&!s.tags.year&&(o.year=n.tags.year),n.tags.quarter&&!s.tags.quarter&&(o.quarter=n.tags.quarter),n.tags.month&&!s.tags.month&&(o.month=n.tags.month),n.tags.week&&!s.tags.week&&(o.week=n.tags.week);let l=he(s.tags,o);if(fe(s.tags,l)){s.tags=l;let i=pe(t,s.path);i&&await Lt(window.app,i,s.tags),console.debug("[WishMap] Top-down fill",{child:s.path,tags:s.tags})}}}function pe(t,e){return window.app.vault.getAbstractFileByPath(e)}var yt=require("obsidian");function En(){let t,e;return{init(n,a){t=n,e=a},onNoteOpen(n){let a=e.getNode(n);if(a){if(a.type==="goal"&&!a.tags.year){new yt.Notice("WishMap: Schedule this goal for a year.");return}if(a.type==="project"&&(a.primaryParent?e.getNode(a.primaryParent):void 0)?.tags.year&&!a.tags.quarter){new yt.Notice("WishMap: Assign a quarter for this project.");return}a.type==="task"&&!a.yaml.due&&(jr(e,a).some(o=>!o.tags.year||!o.tags.quarter)?new yt.Notice("WishMap: Set a due date. Parents are unscheduled, we'll fill them automatically."):new yt.Notice("WishMap: Set a due date or week for this task."))}}}}function jr(t,e){let n=[];for(let a of e.parents){let r=t.getNode(a);r&&n.push(r)}return n}var Ot=class extends v.Plugin{constructor(){super(...arguments);this.initializingPaths=new Set;this.data={};this._openedDailyGuard=!1;this.indexer=Mn();this.inference=Pn();this.prompts=En()}async onload(){console.debug("[WishMap] loading\u2026"),await this.indexer.init(this.app),this.store=this.indexer.getStore(),await this.inference.run(this.store),this.prompts.init(this.app,this.store),this.areaScheduler=new Pt(this.app),this.registerMarkdownPostProcessor((i,c)=>{this.areaScheduler.postProcess(i,c)}),this.addCommand({id:"wishmap-refresh-area-schedule",name:"WishMap: Refresh Area Schedule",callback:()=>{let i=this.app.workspace.getActiveViewOfType(v.MarkdownView);if(!i)return;let c=i.getMode?.();i.setMode?.(c==="preview"?"source":"preview"),i.setMode?.("preview")}}),this.registerEvent(this.app.vault.on("create",async i=>{i instanceof v.TFile&&i.extension==="md"&&(this.indexer.onFileCreate(i),await this.inference.onNodeChange(this.store,i.path))})),this.registerEvent(this.app.vault.on("modify",async i=>{i instanceof v.TFile&&i.extension==="md"&&(this.indexer.onFileModify(i),await this.inference.onNodeChange(this.store,i.path))})),this.registerEvent(this.app.vault.on("delete",i=>{this.indexer.onFileDelete(i)})),this.registerEvent(this.app.workspace.on("file-open",i=>{i&&this.prompts.onNoteOpen(i.path)})),console.log("WishMap v0.2 loaded"),ee(this),console.log("[WishMap] rollup auto: setup called from main"),pn(this),this.addCommand({id:"wishmap-generate-area-maps",name:"Generate Area Maps note",callback:async()=>{let i=await gn(this.app),c=this.app.vault.getAbstractFileByPath(i);c&&this.app.workspace.getLeaf(!0).openFile(c)}}),this.addCommand({id:"wishmap-print-note",name:"Print (Export to PDF)",callback:()=>{this.app.commands.executeCommandById?.("markdown:export-pdf")}}),await this.loadSettings();let n=new Map,a=i=>{let c=i.path,d=n.get(c);d&&window.clearTimeout(d);let u=window.setTimeout(async()=>{n.delete(c),await dt(this.app,i)},300);n.set(c,u)};this.registerEvent(this.app.vault.on("create",async i=>{let c=i;!(c instanceof v.TFile)||c.extension!=="md"||window.setTimeout(async()=>{if(!G(this.app,c))return;let d=j(this.app,c);for(let u of d)a(u)},300)})),this.registerEvent(this.app.metadataCache.on("changed",async i=>{let c=i;if(!(c instanceof v.TFile)||c.extension!=="md"||!G(this.app,c))return;let d=j(this.app,c);for(let u of d)a(u)})),this.addCommand({id:"project-rollup-duration-hours",name:"Project: Roll up duration_hours from linked tasks",callback:async()=>{}}),this.addCommand({id:"create-starter-structure",name:"Create Starter Structure",callback:async()=>{await be(this.app),new v.Notice("Starter structure created.")}}),Te(this.app),this.registerEvent(this.app.vault.on("create",async i=>{let c=i instanceof v.TFile?i:null;if(!c||c.extension!=="md")return;let u=this.app.metadataCache.getFileCache(c)?.frontmatter;(u&&(u.type==="habit"||u.category==="habit")||/\bhabit\b/i.test(c.basename))&&await Ge(this.app,c)})),this.registerEvent(this.app.workspace.on("file-open",async i=>{i&&await lt(this.app,i)})),Fe(this.app),Ee(this.app),Ve(this),Xe(this),this.addCommand({id:"open-today",name:"Open Today",callback:async()=>this.createOrOpenTodayDaily()}),this.addCommand({id:"run-habit-autolog",name:"Habit: Run Autolog for Scheduled Habits",callback:async()=>{await Ue(this.app),new v.Notice("Habit autolog completed.")}}),this.addCommand({id:"toggle-first-checkbox",name:"Toggle First Checkbox",callback:async()=>{let i=this.app.workspace.getActiveFile();if(!i)return new v.Notice("No active file.");await Me(this.app,i)}}),this.addCommand({id:"habit-add-today-line",name:"Habit: Append Today Line",callback:async()=>{let i=this.app.workspace.getActiveFile();if(!i)return new v.Notice("No active file.");await lt(this.app,i)}}),this.addCommand({id:"wishmap-rescan",name:"WishMap: Rescan vault",callback:async()=>{new v.Notice("WishMap: Rescanning\u2026"),await this.indexer.rescanAll(),await this.inference.run(this.store),new v.Notice("WishMap: Rescan complete.")}}),this.addCommand({id:"wishmap-rebuild-inference",name:"WishMap: Rebuild inference",callback:async()=>{new v.Notice("WishMap: Rebuilding inference\u2026"),await this.inference.run(this.store),new v.Notice("WishMap: Inference rebuilt.")}});let r=!1;this.app.workspace.onLayoutReady(()=>{r||(this.ensureTodayDailyOpenOnce(),r=!0)}),this.registerEvent(this.app.metadataCache.on("resolved",()=>{r||(this.ensureTodayDailyOpenOnce(),r=!0)})),console.log("WishMap ready");let s=new Map,o=(i,c=300)=>{let d=i.path,u=s.get(d);u&&window.clearTimeout(u);let h=window.setTimeout(async()=>{s.delete(d),await dt(this.app,i)},c);s.set(d,h)},l=(i,c=1500)=>new Promise(d=>{let u=!1,h=()=>{u||(u=!0,d())},p=this.app.metadataCache.on("changed",f=>{f?.path===i&&(this.app.metadataCache.offref(p),h())});window.setTimeout(()=>{this.app.metadataCache.offref(p),h()},c)});this.registerEvent(this.app.vault.on("create",async i=>{let c=i;!(c instanceof v.TFile)||c.extension!=="md"||window.setTimeout(async()=>{if(!G(this.app,c))return;await l(c.path,1500);let d=j(this.app,c);for(let u of d)o(u,200)},300)})),this.registerEvent(this.app.metadataCache.on("changed",async i=>{let c=i;if(!(c instanceof v.TFile)||c.extension!=="md"||!G(this.app,c))return;let d=j(this.app,c);for(let u of d)o(u,200)})),this.registerEvent(this.app.metadataCache.on("changed",async i=>{let c=i;!(c instanceof v.TFile)||c.extension!=="md"||I(this.app,c)&&o(c,200)})),ee(this)}onunload(){console.log("WishMap unloaded")}async openRouted(n){switch(n.type){case"task":await We(this.app,n.name??"");break;case"project":await _e(this.app,n.name??"");break;case"goal":await Be(this.app,n.name??"");break;case"daily":await ct(this.app);break}}todayISO(){return window.moment().format("YYYY-MM-DD")}pathForTodayDaily(){let n=window.moment(),a=n.format("YYYY-MM-DD"),r=n.format("dddd");return`02 Execution/1 Daily/${a} ${r}.md`}async createOrOpenTodayDaily(){let n=(0,v.normalizePath)(this.pathForTodayDaily()),a=this.app.vault.getAbstractFileByPath(n);if(a instanceof v.TFile){await this.app.workspace.getLeaf(!0).openFile(a);return}let s=this.app.vault.getAbstractFileByPath("03 SaveBox/Templates/Daily Template.md"),o="";s instanceof v.TFile&&(o=await this.app.vault.read(s),o=o.replace(/{{date}}/g,this.todayISO()));let l=await this.app.vault.create(n,o);await this.app.workspace.getLeaf(!0).openFile(l),console.log("Created today\u2019s daily:",n)}async ensureTodayDailyOpenOnce(){if(this._openedDailyGuard)return;let n=this.todayISO(),a=(0,v.normalizePath)(this.pathForTodayDaily()),r=this.app.vault.getAbstractFileByPath(a);if(r instanceof v.TFile){await this.app.workspace.getLeaf(!0).openFile(r),this._openedDailyGuard=!0,this.data.lastDailyISO=n,await this.saveSettings();return}await this.createOrOpenTodayDaily(),this._openedDailyGuard=!0,this.data.lastDailyISO=n,await this.saveSettings()}async loadSettings(){let n=await this.loadData();this.data=n??{}}async saveSettings(){await this.saveData(this.data)}};
